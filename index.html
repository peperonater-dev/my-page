<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æå ±å‘Šæ›¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        :root {
            --consulting-navy: #002D5B;
            --consulting-gold: #A68966;
            --consulting-gray: #F4F7F9;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        @media print {
            .no-print { display: none !important; }
            .print-page { display: block !important; }
            body { background-color: white; padding: 0; margin: 0; }
            .shadow-lg { box-shadow: none !important; }
            .slide-break { page-break-before: always; }
            #coverPage {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background-color: var(--consulting-navy) !important;
                -webkit-print-color-adjust: exact;
                color: white !important;
                text-align: center;
            }
        }

        .print-page { display: none; }

        .table-input {
            width: 100%;
            text-align: center;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 4px 2px;
            font-weight: 500;
        }

        .input-col {
            background-color: #f8fafc;
            border-right: 3px solid #64748b !important;
            min-width: 180px;
            position: sticky;
            left: 0;
            z-index: 40;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .memo-input {
            width: 100%;
            text-align: left;
            background-color: #fffbeb;
            border: 1px dashed #f59e0b;
            border-radius: 4px;
            padding: 6px;
            font-size: 11px;
            min-height: 50px;
        }

        .chart-container { position: relative; height: 350px; width: 100%; }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .toggle-btn.active {
            background-color: var(--consulting-navy);
            color: white;
        }

        .asset-total-row { background-color: #064e3b; color: white; }
        .asset-sub-row { background-color: #ecfdf5; }
        .income-header-row { background-color: #1e3a8a; color: white; }
        .expense-header-row { background-color: #881337; color: white; }
    </style>
</head>
<body class="p-2 md:p-6">

    <!-- å°åˆ·ç”¨ï¼šè¡¨ç´™ -->
    <div id="coverPage" class="print-page">
        <div class="border-y-2 border-white py-12 px-20 mb-12">
            <h1 class="text-5xl font-light tracking-widest mb-4">Financial Analysis Report</h1>
            <p class="text-2xl font-bold tracking-widest">ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æå ±å‘Šæ›¸</p>
        </div>
        <div class="text-xl">
            <p class="mb-2">é¡§å®¢åï¼š<span class="clientNameLabel">ã”ç›¸è«‡è€…æ§˜</span></p>
            <p class="mb-8">ä½œæˆæ—¥ï¼š<span class="todayDateLabel"></span></p>
            <div class="h-1 w-20 bg-white mb-8 mx-auto"></div>
            <p class="text-sm tracking-widest uppercase">Prepared by FP Consulting Service</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="reportArea" class="max-w-[1600px] mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden mb-8 slide-break">
        <!-- Header -->
        <div class="bg-[#002D5B] p-6 md:p-8 text-white flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-widest opacity-70 mb-1">Professional Consulting Platform</p>
                <h1 class="text-xl md:text-3xl font-medium tracking-tight">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
                <div class="flex flex-wrap gap-x-6 gap-y-1 text-slate-300 text-xs md:sm mt-2 font-light">
                    <p>é¡§å®¢å: <span id="displayClientName" class="clientNameLabel font-bold text-white">ã”ç›¸è«‡è€…æ§˜</span></p>
                    <p>ä½œæˆæ—¥: <span class="todayDateLabel"></span></p>
                </div>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="openModal('loadModal')" class="bg-white/10 hover:bg-white/20 text-white text-xs px-4 py-2 rounded-lg transition border border-white/30">èª­è¾¼</button>
                <button onclick="openModal('saveModal')" class="bg-emerald-600 hover:bg-emerald-50 text-white text-xs px-6 py-2 rounded-lg font-bold shadow-lg transition">ä¿å­˜</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-slate-50 p-4 border-b flex flex-wrap gap-4 items-center no-print">
            <div class="flex bg-white rounded-xl p-1 shadow-sm border items-center">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">è¡¨ç¤ºåˆ‡æ›¿</span>
                <button id="view5yr" onclick="setViewInterval(5)" class="toggle-btn active px-4 py-1.5 text-xs rounded-lg transition font-medium">5å¹´ã”ã¨</button>
                <button id="view1yr" onclick="setViewInterval(1)" class="toggle-btn px-4 py-1.5 text-xs rounded-lg transition font-medium">1å¹´ã”ã¨</button>
            </div>
            <div class="flex bg-white rounded-xl p-1 shadow-sm border items-center">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">ã‚°ãƒ©ãƒ•å½¢å¼</span>
                <button id="chartLine" onclick="setChartType('line')" class="toggle-btn active px-4 py-1.5 text-xs rounded-lg transition font-medium">è³‡ç”£æ¨ç§»</button>
                <button id="chartPie" onclick="setChartType('pie')" class="toggle-btn px-4 py-1.5 text-xs rounded-lg transition font-medium">åæ”¯æ§‹æˆ</button>
            </div>
            <div class="ml-auto">
                <button onclick="openModal('configModal')" class="bg-[#002D5B] text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-slate-800 transition shadow-lg flex items-center">
                    <span class="mr-2">âš™ï¸</span> è©³ç´°è¨­å®šãƒ‘ãƒãƒ«
                </button>
            </div>
        </div>

        <div class="p-4 md:p-8">
            <!-- Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
                <div class="bg-slate-50 border-l-4 border-[#002D5B] p-5 rounded-r-xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“</p>
                    <p class="text-xl font-bold text-slate-700" id="summaryDuration">---</p>
                </div>
                <div class="bg-slate-50 border-l-4 border-emerald-600 p-5 rounded-r-xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">åœŸåœ°å»ºç‰©ç·é¡</p>
                    <p class="text-xl font-bold text-slate-700" id="summaryProperty">Â¥0</p>
                </div>
                <div class="bg-slate-50 border-l-4 border-amber-500 p-5 rounded-r-xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">é‹ç”¨æœŸå¾…åˆ©å›ã‚Š</p>
                    <p class="text-xl font-bold text-slate-700" id="summaryYield">0%</p>
                </div>
                <div class="bg-slate-50 border-l-4 border-rose-600 p-5 rounded-r-xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">ãƒ­ãƒ¼ãƒ³å€Ÿå…¥ç·é¡</p>
                    <p class="text-xl font-bold text-slate-700" id="summaryLoan">Â¥0</p>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm mb-12">
                <h3 id="chartTitle" class="text-sm font-bold text-slate-600 flex items-center mb-6">
                    <span class="w-1.5 h-4 bg-[#002D5B] mr-2 rounded-full"></span>
                    é‡‘èè³‡ç”£æ®‹é«˜ã®å°†æ¥æ¨ç§»
                </h3>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto border border-slate-200 rounded-2xl shadow-xl bg-white">
                <table class="w-full text-left border-collapse text-xs md:text-sm" id="cfTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody" class="font-medium"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-slate-50 p-8 border-t flex flex-col md:flex-row justify-between items-center gap-6 no-print">
            <p class="text-xs text-slate-400 max-w-xl italic">
                â€»å·¦å´ã®å…¥åŠ›åˆ—ã§å¹´é½¢ã‚„äººæ•°ã‚’å¤‰æ›´å¯èƒ½ã§ã™ã€‚åœŸåœ°å»ºç‰©ç·é¡ã¯è³¼å…¥å¹´ã®æ”¯å‡ºã¨ã—ã¦è¨ˆä¸Šã•ã‚Œã¾ã™ã€‚
            </p>
            <button onclick="window.print()" class="bg-[#002D5B] text-white px-12 py-4 rounded-2xl font-bold shadow-2xl hover:scale-105 transition transform">
                è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’PDFä¿å­˜
            </button>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="configModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-8 border-b pb-4 text-[#002D5B]">ğŸ“ è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                
                <!-- ä½å®…ãƒ­ãƒ¼ãƒ³ãƒ»åœŸåœ°å»ºç‰© -->
                <div class="space-y-6">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                        <h3 class="font-bold text-blue-900 mb-4 flex items-center">ğŸ  åœŸåœ°å»ºç‰©ãƒ»ä½å®…ãƒ­ãƒ¼ãƒ³è¨ˆç”»</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-blue-800 font-bold block mb-1">åœŸåœ°å»ºç‰©ç·é¡ (ä¸‡å††)</label>
                                <input type="number" id="propertyTotal" value="4500" class="w-full border border-blue-300 rounded-xl p-3 text-lg font-bold text-blue-900 focus:ring-2 focus:ring-blue-400 outline-none" onchange="updateSimulation()">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-blue-700 font-bold block mb-1">ä½å®…ãƒ­ãƒ¼ãƒ³å€Ÿå…¥é¡ (ä¸‡å††)</label>
                                    <input type="number" id="loanAmount" value="4000" class="w-full border border-blue-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-blue-700 font-bold block mb-1">å€Ÿå…¥é‡‘åˆ© (%)</label>
                                    <input type="number" id="loanRate" value="1.0" step="0.1" class="w-full border border-blue-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-blue-700 font-bold block mb-1">å¹´é–“è¿”æ¸ˆé¡ (ä¸‡å††)</label>
                                    <input type="number" id="loanRepaymentYear" value="140" class="w-full border border-blue-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-blue-700 font-bold block mb-1">è¦ªã‹ã‚‰ã®æ´åŠ©é‡‘ (ä¸‡å††)</label>
                                    <input type="number" id="parentSupport" value="0" class="w-full border border-blue-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éš ã—è¨­å®šç”¨ -->
                    <div class="hidden">
                        <input type="number" id="duration" value="50">
                        <input type="number" id="baseAge" value="35">
                        <input type="number" id="spouseAge" value="32">
                        <select id="childCount"><option value="3" selected></option></select>
                        <input type="number" id="child1Age" value="5">
                        <input type="number" id="child2Age" value="2">
                        <input type="number" id="child3Age" value="0">
                    </div>
                </div>

                <!-- è³‡ç”£é‹ç”¨ãƒ»DC -->
                <div class="space-y-6">
                    <div class="bg-emerald-50 p-6 rounded-2xl border border-emerald-100">
                        <h3 class="font-bold text-emerald-900 mb-4 flex items-center">ğŸ“ˆ è³‡ç”£é‹ç”¨ãƒ»è¤‡åˆ©è¨­å®š</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] text-emerald-700 font-bold block mb-1">é‹ç”¨äºˆæƒ³åˆ©å›ã‚Š (%)</label>
                                <input type="number" id="investRate" value="3.0" step="0.1" class="w-full border border-emerald-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                            </div>
                            <div>
                                <label class="text-[10px] text-emerald-700 font-bold block mb-1">ä¼æ¥­å‹DCæ‹ å‡ºé¡ / å¹´ (ä¸‡)</label>
                                <input type="number" id="dcYearly" value="24" class="w-full border border-emerald-200 rounded-lg p-2 text-sm" onchange="updateSimulation()">
                            </div>
                        </div>
                        <div class="mt-6">
                            <label class="text-xs font-bold text-emerald-800 block mb-3">ç¾åœ¨ã®è³‡ç”£æ®‹é«˜ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ï¼‰</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-[9px] text-emerald-600 block">ç¾é‡‘ãƒ»é é‡‘ (ä¸‡)</label>
                                    <input type="number" id="currentCash" value="1000" class="w-full border border-emerald-200 rounded p-2 text-sm" onchange="updateSimulation()">
                                </div>
                                <div>
                                    <label class="text-[9px] text-emerald-600 block">æŠ•è³‡è³‡ç”£ (ä¸‡)</label>
                                    <input type="number" id="currentInvest" value="300" class="w-full border border-emerald-200 rounded p-2 text-sm" onchange="updateSimulation()">
                                </div>
                                <div>
                                    <label class="text-[9px] text-emerald-600 block">ä¼æ¥­å‹DC (ä¸‡)</label>
                                    <input type="number" id="currentDC" value="50" class="w-full border border-emerald-200 rounded p-2 text-sm" onchange="updateSimulation()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t flex justify-end">
                <button onclick="closeModal('configModal'); updateSimulation();" class="bg-[#002D5B] text-white px-16 py-3 rounded-2xl font-bold shadow-xl">è¨­å®šã‚’ä¿å­˜ã—ã¦åæ˜ </button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¿å­˜ãƒ»èª­è¾¼ï¼‰ -->
    <div id="saveModal" class="modal-backdrop"><div class="modal-content text-center"><h2 class="text-xl font-bold mb-6">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜</h2><input type="text" id="saveNameInput" class="w-full border-2 border-slate-100 p-4 rounded-xl mb-6 text-lg" placeholder="ä¾‹ï¼šæ—æ§˜ 2025å¹´æ¡ˆ"><div class="flex justify-center gap-3"><button onclick="closeModal('saveModal')" class="px-8 py-2 text-slate-400">é–‰ã˜ã‚‹</button><button id="saveBtn" onclick="savePlan()" class="bg-[#002D5B] text-white px-10 py-2 rounded-xl font-bold shadow-lg">ä¿å­˜</button></div></div></div>
    <div id="loadModal" class="modal-backdrop"><div class="modal-content"><h2 class="text-xl font-bold mb-6">ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³</h2><div id="planList" class="space-y-3 mb-6 max-h-96 overflow-y-auto border-t pt-4"></div><div class="flex justify-end"><button onclick="closeModal('loadModal')" class="px-6 py-2 text-slate-400">é–‰ã˜ã‚‹</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDr8lWJp-dHftPPBNvlke28r5-NdUyngnI",
            authDomain: "my-cashflow-sim.firebaseapp.com",
            projectId: "my-cashflow-sim",
            storageBucket: "my-cashflow-sim.firebasestorage.app",
            messagingSenderId: "520084319258",
            appId: "1:520084319258:web:747fc1c64302b2ace935a3",
            measurementId: "G-200LZFT53K"
        };

        const appId = "cashflow-sim-storage";
        let db, auth, currentUser = null;

        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (user) => { currentUser = user; });
                await signInAnonymously(auth);
            } catch (err) { console.error("Firebase Auth Error:", err); }
        };

        window.savePlan = async () => {
            if (!currentUser) return;
            const name = document.getElementById('saveNameInput').value.trim();
            if (!name) return;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            try {
                const configIds = [
                    'duration', 'baseAge', 'spouseAge', 'childCount', 'child1Age', 'child2Age', 'child3Age',
                    'propertyTotal', 'currentCash', 'currentInvest', 'currentDC',
                    'loanAmount', 'loanRate', 'loanRepaymentYear', 'investRate', 'dcYearly', 'parentSupport'
                ];
                const config = {};
                configIds.forEach(id => { config[id] = document.getElementById(id).value; });

                const data = {
                    name, config, updatedAt: serverTimestamp(),
                    incomes: Array.from(document.querySelectorAll('.income-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })),
                    expenses: Array.from(document.querySelectorAll('.expense-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })),
                    memos: Array.from(document.querySelectorAll('.memo-input')).map(el => el.value)
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', encodeURIComponent(name)), data);
                alert("ä¿å­˜ã—ã¾ã—ãŸ"); closeModal('saveModal');
                document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = name);
            } catch (err) { alert("ä¿å­˜å¤±æ•—"); } finally { btn.disabled = false; }
        };

        window.loadPlansList = async () => {
            const listArea = document.getElementById('planList');
            if(!listArea) return;
            listArea.innerHTML = 'èª­è¾¼ä¸­...';
            if (!currentUser) return;
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scenarios'));
                listArea.innerHTML = snap.empty ? 'ãƒ‡ãƒ¼ã‚¿ãªã—' : '';
                snap.forEach(d => {
                    const p = d.data();
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-4 border rounded-xl hover:bg-blue-50 cursor-pointer mb-2";
                    item.innerHTML = `<div class="flex-grow" onclick="window.fetchAndLoadPlan('${d.id}')"><b>${p.name}</b></div><button onclick="window.deletePlan('${d.id}')" class="text-rose-500 text-xs">å‰Šé™¤</button>`;
                    listArea.appendChild(item);
                });
            } catch (err) { listArea.innerHTML = 'ã‚¨ãƒ©ãƒ¼'; }
        };

        window.fetchAndLoadPlan = async (id) => {
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id));
                if (!snap.exists()) return;
                const p = snap.data();
                Object.keys(p.config).forEach(k => { const el = document.getElementById(k); if(el) el.value = p.config[k]; });
                initTable();
                p.incomes.forEach(i => { const el = document.querySelector(`.income-input[data-cat="${i.cat}"][data-col="${i.col}"]`); if (el) el.value = i.val; });
                p.expenses.forEach(e => { const el = document.querySelector(`.expense-input[data-cat="${e.cat}"][data-col="${e.col}"]`); if (el) el.value = e.val; });
                const memos = document.querySelectorAll('.memo-input');
                p.memos.forEach((txt, idx) => { if (memos[idx]) memos[idx].value = txt; });
                document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = p.name);
                window.updateSimulation(); closeModal('loadModal');
            } catch (err) { alert("èª­è¾¼å¤±æ•—"); }
        };

        window.deletePlan = async (id) => { if (confirm("å‰Šé™¤?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id)); window.loadPlansList(); } };

        setupFirebase();
    </script>

    <script>
        let mainChart;
        let viewInterval = 5;
        let chartType = 'line';
        const expenseCats = [
            {id:'basicLiving', label:'åŸºæœ¬ç”Ÿæ´»è²»', def:240}, {id:'housing', label:'ä½å±…é–¢é€£è²»', def:120},
            {id:'vehicle', label:'è»Šä¸¡è²»', def:30}, {id:'education', label:'æ•™è‚²è²»', def:30},
            {id:'insurance', label:'ä¿é™ºæ–™', def:20}, {id:'other', label:'ãã®ä»–ã®æ”¯å‡º', def:10}
        ];

        function setViewInterval(val) {
            viewInterval = val;
            const v1 = document.getElementById('view1yr');
            const v5 = document.getElementById('view5yr');
            if(v1) v1.classList.toggle('active', val === 1);
            if(v5) v5.classList.toggle('active', val === 5);
            initTable();
            updateSimulation();
        }

        function setChartType(type) {
            chartType = type;
            const cl = document.getElementById('chartLine');
            const cp = document.getElementById('chartPie');
            if(cl) cl.classList.toggle('active', type === 'line');
            if(cp) cp.classList.toggle('active', type === 'pie');
            updateSimulation();
        }

        function initTable() {
            const duration = parseInt(document.getElementById('duration')?.value || 50);
            const columns = [];
            for (let i = 0; i <= duration; i += viewInterval) columns.push(i);

            const thead = document.getElementById('tableHeader');
            thead.innerHTML = `<tr class="bg-slate-800 text-white shadow-md">
                <th class="p-5 input-col text-slate-800">åŸºæœ¬å…¥åŠ›é …ç›®</th>
                ${columns.map((c, i) => `<th class="p-5 text-center font-bold ${i===0?'bg-slate-700':''}">${c===0?'ç¾åœ¨':c+'å¹´å¾Œ'}</th>`).join('')}
            </tr>`;

            const tbody = document.getElementById('tableBody');
            let html = `<tr class="bg-amber-50/20"><td class="p-4 input-col font-bold text-amber-900 border-b text-[11px]">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</td>${columns.map((_, i) => `<td class="p-2 border-b"><textarea class="memo-input event-memo" data-col="${i}" oninput="updateSimulation()" placeholder="ãƒ¡ãƒ¢"></textarea></td>`).join('')}</tr>`;
            
            html += `<tr class="bg-slate-50"><td class="p-4 input-col font-bold border-b text-slate-600 text-[11px]">çµŒéå¹´æ•° (å¹´)<br><input type="number" id="duration_T" class="table-input mt-1" onchange="syncAndRefresh('duration', this.value); initTable();"></td>${columns.map((_, i) => `<td class="p-3 border-b text-center text-slate-400">${columns[i]}å¹´</td>`).join('')}</tr>`;

            html += `<tr class="bg-slate-50/50"><td class="p-4 input-col font-bold border-b text-[11px]">æœ¬äººå¹´é½¢<br><input type="number" id="baseAge_T" class="table-input mt-1" onchange="syncAndRefresh('baseAge', this.value)"></td>${columns.map((_, i) => `<td class="p-3 border-b text-center font-bold text-slate-800" data-type="ageSelf" data-col="${i}">---</td>`).join('')}</tr>`;
            html += `<tr class="bg-slate-50/50"><td class="p-4 input-col font-bold border-b text-[11px]">é…å¶è€…å¹´é½¢<br><input type="number" id="spouseAge_T" class="table-input mt-1" onchange="syncAndRefresh('spouseAge', this.value)"></td>${columns.map((_, i) => `<td class="p-3 border-b text-center text-slate-500" data-type="ageSpouse" data-col="${i}">---</td>`).join('')}</tr>`;
            html += `<tr class="bg-slate-50/50 border-b-4"><td class="p-4 input-col font-bold text-[11px]">å­ä¾›(æ•°/å¹´é½¢)<br>
                <select id="childCount_T" class="table-input text-[10px] mb-1" onchange="syncAndRefresh('childCount', this.value)"><option value="0">0å</option><option value="1">1å</option><option value="2">2å</option><option value="3">3å</option></select>
                <div class="flex gap-1"><input type="number" id="c1_T" class="table-input w-1/3" onchange="syncAndRefresh('child1Age', this.value)"><input type="number" id="c2_T" class="table-input w-1/3" onchange="syncAndRefresh('child2Age', this.value)"><input type="number" id="c3_T" class="table-input w-1/3" onchange="syncAndRefresh('child3Age', this.value)"></div></td>
                ${columns.map((_, i) => `<td class="p-3 border-b text-center text-[10px]" data-type="ageChildren" data-col="${i}">---</td>`).join('')}</tr>`;
            
            html += `<tr class="income-header-row font-bold"><td class="p-4 input-col bg-blue-50 text-blue-900 border-b text-[11px]">ã€åå…¥åˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center" data-type="totalIncome" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs"><td class="p-3 input-col pl-8 border-b">æœ¬äººåå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="self" data-col="${i}" value="${i===0?500:0}" onchange="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            html += `<tr class="text-xs"><td class="p-3 input-col pl-8 border-b">é…å¶è€…åå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="spouse" data-col="${i}" value="${i===0?150:0}" onchange="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            html += `<tr class="text-xs"><td class="p-3 input-col pl-8 border-b font-bold text-blue-600">ä½å®…ãƒ­ãƒ¼ãƒ³å€Ÿå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b text-center text-blue-600 font-bold" data-type="loanIn" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs border-b-2"><td class="p-3 input-col pl-8 border-b">ä¸€æ™‚çš„ãªåå…¥/ä»–</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="tempInc" data-col="${i}" value="0" onchange="updateSimulation()"></td>`).join('')}</tr>`;
            
            html += `<tr class="expense-header-row font-bold"><td class="p-4 input-col bg-rose-50 text-rose-900 border-b text-[11px]">ã€æ”¯å‡ºåˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center" data-type="totalExpense" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs font-bold text-rose-600"><td class="p-2 input-col pl-8 border-b font-bold text-rose-600">åœŸåœ°å»ºç‰©è³¼å…¥ç·é¡</td>${columns.map((_, i) => `<td class="p-1 border-b text-center text-rose-600 font-bold" data-type="propertyOut" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs font-bold text-rose-600"><td class="p-2 input-col pl-8 border-b">ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆé¡</td>${columns.map((_, i) => `<td class="p-1 border-b text-center" data-type="loanOut" data-col="${i}">0</td>`).join('')}</tr>`;
            expenseCats.forEach((cat, idx) => {
                html += `<tr class="text-xs"><td class="p-2 input-col pl-8 border-b">${cat.label}</td>${columns.map((_, i) => `<td class="p-1 border-b"><input type="number" class="table-input expense-input" data-cat="${cat.id}" data-col="${i}" value="${cat.def}" onchange="updateSimulation()"></td>`).join('')}</tr>`;
            });
            
            html += `<tr class="asset-total-row font-bold border-t-2"><td class="p-4 input-col bg-emerald-900 text-white border-b text-[11px]">ã€è³‡ç”£åˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalAssets" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs asset-sub-row"><td class="p-2 input-col pl-8 border-b">å†…ï¼šç¾é‡‘ãƒ»é é‡‘</td>${columns.map((_, i) => `<td class="p-2 border-b text-center" data-type="assetCash" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs asset-sub-row"><td class="p-2 input-col pl-8 border-b font-medium text-emerald-700">å†…ï¼šæŠ•è³‡è³‡ç”£</td>${columns.map((_, i) => `<td class="p-2 border-b text-center" data-type="assetInvest" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="text-xs asset-sub-row border-b-2"><td class="p-2 input-col pl-8 border-b font-medium text-emerald-700">å†…ï¼šä¼æ¥­å‹DC (65æ­³ã¾ã§å¼•å‡ºä¸å¯)</td>${columns.map((_, i) => `<td class="p-2 border-b text-center" data-type="assetDC" data-col="${i}">0</td>`).join('')}</tr>`;
            
            html += `<tr class="bg-slate-100 font-bold"><td class="p-4 input-col bg-slate-200 border-b text-[11px]">å¹´é–“åæ”¯(Net)</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="balance" data-col="${i}">0</td>`).join('')}</tr>`;
            
            tbody.innerHTML = html;
            syncTableInputs();
        }

        function handleIncomePropagate(el) {
            if (el.dataset.col === "0") {
                const cat = el.dataset.cat;
                const val = el.value;
                const rowInputs = document.querySelectorAll(`.income-input[data-cat="${cat}"]`);
                rowInputs.forEach(input => {
                    if (input.dataset.col !== "0" && (input.value === "0" || input.value === "")) {
                        input.value = val;
                    }
                });
            }
        }

        function syncAndRefresh(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val;
            updateSimulation();
        }

        function syncTableInputs() {
            const pairs = { 'duration_T':'duration', 'baseAge_T':'baseAge', 'spouseAge_T':'spouseAge', 'childCount_T':'childCount', 'c1_T':'child1Age', 'c2_T':'child2Age', 'c3_T':'child3Age' };
            for (const [tId, mId] of Object.entries(pairs)) {
                const t = document.getElementById(tId); const m = document.getElementById(mId);
                if (t && m) t.value = m.value;
            }
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        }

        function setSelectorText(query, val) {
            const el = document.querySelector(query);
            if (el) el.textContent = val;
        }

        window.updateSimulation = () => {
            const baseAge = parseInt(document.getElementById('baseAge')?.value || 35);
            const spouseAge = parseInt(document.getElementById('spouseAge')?.value || 32);
            const duration = parseInt(document.getElementById('duration')?.value || 50);
            const childCount = parseInt(document.getElementById('childCount')?.value || 0);
            const c1 = parseInt(document.getElementById('child1Age')?.value || 0);
            const c2 = parseInt(document.getElementById('child2Age')?.value || 0);
            const c3 = parseInt(document.getElementById('child3Age')?.value || 0);

            const propTotal = parseFloat(document.getElementById('propertyTotal')?.value || 0);
            const initCash = parseFloat(document.getElementById('currentCash')?.value || 0);
            const initInvest = parseFloat(document.getElementById('currentInvest')?.value || 0);
            const initDC = parseFloat(document.getElementById('currentDC')?.value || 0);

            const loanAmt = parseFloat(document.getElementById('loanAmount')?.value || 0);
            const loanRate = parseFloat(document.getElementById('loanRate')?.value || 1.0) / 100;
            const loanRepay = parseFloat(document.getElementById('loanRepaymentYear')?.value || 120);
            const invRate = parseFloat(document.getElementById('investRate')?.value || 3.0) / 100;
            const dcYearly = parseFloat(document.getElementById('dcYearly')?.value || 24);
            const parentSupport = parseFloat(document.getElementById('parentSupport')?.value || 0);

            // Summary Card Updates with safety checks
            const sDur = document.getElementById('summaryDuration');
            if(sDur) sDur.textContent = `${baseAge+duration}æ­³ã¾ã§ (${duration}å¹´)`;
            
            const sLoan = document.getElementById('summaryLoan');
            if(sLoan) sLoan.textContent = `Â¥${loanAmt.toLocaleString()}ä¸‡`;
            
            const sYield = document.getElementById('summaryYield');
            if(sYield) sYield.textContent = `${(invRate*100).toFixed(1)}%`;
            
            const sProp = document.getElementById('summaryProperty');
            if(sProp) sProp.textContent = `Â¥${propTotal.toLocaleString()}ä¸‡`;

            let runningCash = initCash + parentSupport;
            let runningInvest = initInvest;
            let runningDC = initDC;
            let loanBalance = loanAmt;

            const yearlyData = [];
            const columnsTotal = Math.floor(duration / viewInterval);

            for (let year = 0; year <= duration; year++) {
                const colIdx = year / viewInterval;
                const safeCol = Math.floor(colIdx) > columnsTotal ? columnsTotal : Math.floor(colIdx);

                let tInc = 0;
                document.querySelectorAll(`.income-input[data-col="${safeCol}"]`).forEach(el => tInc += parseFloat(el.value || 0));
                const loanIn = (year === 0) ? loanAmt : 0;
                tInc += loanIn;

                let tExp = 0;
                document.querySelectorAll(`.expense-input[data-col="${safeCol}"]`).forEach(el => tExp += parseFloat(el.value || 0));
                const propertyOut = (year === 0) ? propTotal : 0;
                tExp += propertyOut;

                let curLoanOut = 0;
                if (loanBalance > 0) {
                    const interest = loanBalance * loanRate;
                    curLoanOut = Math.min(loanRepay, loanBalance + interest);
                    loanBalance = Math.max(0, loanBalance + interest - curLoanOut);
                }
                tExp += curLoanOut;

                if (year > 0) {
                    runningInvest *= (1 + invRate);
                    runningDC = (runningDC + dcYearly) * (1 + invRate);
                }

                const bal = tInc - tExp;
                runningCash += (bal - (year > 0 ? dcYearly : 0));

                if (year % viewInterval === 0) {
                    setSelectorText(`[data-type="ageSelf"][data-col="${colIdx}"]`, `${baseAge+year}æ­³`);
                    setSelectorText(`[data-type="ageSpouse"][data-col="${colIdx}"]`, `${spouseAge+year}æ­³`);
                    let cText = [];
                    if(childCount >= 1) cText.push(`â‘ ${c1+year}`);
                    if(childCount >= 2) cText.push(`â‘¡${c2+year}`);
                    if(childCount >= 3) cText.push(`â‘¢${c3+year}`);
                    setSelectorText(`[data-type="ageChildren"][data-col="${colIdx}"]`, cText.length ? cText.join(' ') : '---');

                    setSelectorText(`[data-type="totalIncome"][data-col="${colIdx}"]`, Math.floor(tInc).toLocaleString());
                    setSelectorText(`[data-type="loanIn"][data-col="${colIdx}"]`, loanIn > 0 ? loanIn.toLocaleString() : '0');
                    setSelectorText(`[data-type="totalExpense"][data-col="${colIdx}"]`, Math.floor(tExp).toLocaleString());
                    setSelectorText(`[data-type="propertyOut"][data-col="${colIdx}"]`, propertyOut > 0 ? propertyOut.toLocaleString() : '0');
                    setSelectorText(`[data-type="loanOut"][data-col="${colIdx}"]`, Math.floor(curLoanOut).toLocaleString());
                    setSelectorText(`[data-type="assetCash"][data-col="${colIdx}"]`, Math.floor(runningCash).toLocaleString());
                    setSelectorText(`[data-type="assetInvest"][data-col="${colIdx}"]`, Math.floor(runningInvest).toLocaleString());
                    setSelectorText(`[data-type="assetDC"][data-col="${colIdx}"]`, Math.floor(runningDC).toLocaleString());
                    
                    const totalAsset = runningCash + runningInvest + runningDC;
                    const aEl = document.querySelector(`[data-type="totalAssets"][data-col="${colIdx}"]`);
                    if(aEl) {
                        aEl.textContent = Math.floor(totalAsset).toLocaleString();
                        aEl.className = `p-4 border-b text-center font-bold ${totalAsset>=0?'text-emerald-700':'text-rose-700'}`;
                    }

                    const bEl = document.querySelector(`[data-type="balance"][data-col="${colIdx}"]`);
                    if(bEl) {
                        bEl.textContent = (bal>=0?'+':'') + Math.floor(bal).toLocaleString();
                        bEl.className = `p-4 border-b text-center font-bold ${bal>=0?'text-emerald-600':'text-rose-600'}`;
                    }
                    if(year === 0) {
                        const sBal = document.getElementById('summaryBalance');
                        if(sBal) sBal.textContent = `Â¥${Math.floor(bal).toLocaleString()}ä¸‡`;
                    }
                }
                yearlyData.push({ year, age: baseAge+year, assets: runningCash + runningInvest + runningDC, income: tInc, expense: tExp });
            }
            renderCharts(yearlyData);
        };

        function renderCharts(data) {
            const ctxEl = document.getElementById('mainChart');
            if(!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            if (mainChart) mainChart.destroy();
            if (chartType === 'line') {
                const skip = (viewInterval===1) ? 2 : 1;
                const labels = data.filter((d,i) => i % skip === 0).map(d => `${d.age}æ­³`);
                const assets = data.filter((d,i) => i % skip === 0).map(d => d.assets);
                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'ç·è³‡ç”£é¡', data: assets, borderColor: '#002D5B', backgroundColor: 'rgba(0,45,91,0.05)', fill: true, tension: 0.3 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            } else {
                const incomes = Array.from(document.querySelectorAll('.income-input[data-col="0"]')).map(el => parseFloat(el.value||0));
                const expenses = Array.from(document.querySelectorAll('.expense-input[data-col="0"]')).map(el => parseFloat(el.value||0));
                const loanPay = parseFloat(document.querySelector('[data-type="loanOut"][data-col="0"]')?.textContent.replace(/,/g,'') || 0);
                mainChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æœ¬äººåå…¥', 'é…å¶è€…åå…¥', 'ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ', 'åŸºæœ¬ç”Ÿæ´»è²»', 'ä½å±…è²»', 'æ•™è‚²è²»', 'ãã®ä»–'],
                        datasets: [{ data: [incomes[0], incomes[1], loanPay, expenses[0], expenses[1], expenses[3], expenses[4]||0], backgroundColor: ['#3b82f6','#60a5fa','#f87171','#fca5a5','#fb7185','#fbbf24','#94a3b8'] }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }
        }

        window.openModal = (id) => { 
            const el = document.getElementById(id);
            if(el) el.style.display = 'flex';
            if(id==='loadModal') window.loadPlansList(); 
        };
        window.closeModal = (id) => { 
            const el = document.getElementById(id);
            if(el) el.style.display = 'none'; 
        };

        function initDate() {
            const d = new Date();
            document.querySelectorAll('.todayDateLabel').forEach(el => el.textContent = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`);
        }

        document.addEventListener('DOMContentLoaded', () => { 
            initDate(); 
            initTable(); 
            updateSimulation(); 
        });
    </script>
</body>
</html>