<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æå ±å‘Šæ›¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        :root {
            --consulting-navy: #002D5B;
            --consulting-gold: #A68966;
            --consulting-gray: #F4F7F9;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«è¨­å®š --- */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            max-width: 1000px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* --- å°åˆ·ãƒ»PDFä¿å­˜ç”¨è¨­å®š --- */
        #printOnlyArea { display: none; }

        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            .no-print { display: none !important; }
            #reportArea { display: none !important; }
            #printOnlyArea { display: block !important; }
            .modal-backdrop { display: none !important; }
            
            body { background-color: white !important; }
            .page-break { page-break-after: always; }
            
            .print-cover {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background-color: var(--consulting-navy) !important;
                color: white !important;
                text-align: center;
                -webkit-print-color-adjust: exact;
            }
            .print-cover h1 { font-size: 32px; margin-bottom: 20px; border-bottom: 2px solid white; padding-bottom: 10px; width: 80%; }

            h2 { font-size: 18px !important; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: var(--consulting-navy); border-left: 5px solid var(--consulting-navy); padding-left: 10px; }

            table { width: 100% !important; border-collapse: collapse !important; font-size: 6px !important; margin-bottom: 25px; table-layout: fixed; }
            th, td { border: 1px solid #cbd5e1 !important; padding: 3px 1px !important; text-align: center; word-wrap: break-word; }
            .bg-slate-800 { background-color: #1e293b !important; color: white !important; -webkit-print-color-adjust: exact; }
            
            .print-income-header { background-color: #eff6ff !important; color: #1e40af !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-expense-header { background-color: #fff1f2 !important; color: #9f1239 !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-asset-header { background-color: #ecfdf5 !important; color: #064e3b !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            
            .print-label-col { width: 130px !important; font-weight: bold; text-align: left !important; padding-left: 5px !important; background-color: #f8fafc !important; }
            .print-sub-label { padding-left: 15px !important; font-weight: normal; }

            .print-chart-row { display: flex; gap: 20px; margin: 20px 0; justify-content: space-between; }
            .print-chart-box { width: 48%; text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
            .print-chart-img { width: 100%; max-height: 250px; object-fit: contain; }

            .pie-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .pie-item { text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; page-break-inside: avoid; }
            .pie-item img { width: 100%; max-height: 150px; object-fit: contain; }
        }

        /* ç”»é¢UI */
        .table-input { width: 100%; text-align: center; background-color: #ffffff; border: 1px solid #000000; border-radius: 4px; padding: 4px 2px; font-weight: 500; }
        .memo-input { width: 100%; text-align: center; background-color: #fffbeb; border: 1px solid #000000; border-radius: 4px; padding: 6px; font-size: 11px; min-height: 50px; }
        .input-col { background-color: #f8fafc; border-right: 3px solid #64748b !important; min-width: 180px; position: sticky; left: 0; z-index: 40; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .toggle-btn.active { background-color: var(--consulting-navy); color: white; }
        
        .text-income-total { color: #1e40af !important; }
        .text-expense-total { color: #be123c !important; }

        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { background-color: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; margin-top: 10px; font-size: 14px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="toastContainer" class="no-print"></div>

    <!-- å°åˆ·ç”¨ã‚¨ãƒªã‚¢ -->
    <div id="printOnlyArea"></div>
    <div style="position: absolute; left: -9999px; top: -9999px;"><canvas id="hiddenPieCanvas" width="500" height="500"></canvas></div>

    <!-- ãƒ¡ã‚¤ãƒ³UI -->
    <div id="reportArea" class="max-w-[1600px] mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden mb-8">
        <!-- Header -->
        <div class="bg-[#002D5B] p-6 md:p-8 text-white flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-widest opacity-70 mb-1">Financial Analysis Tool</p>
                <h1 class="text-xl md:text-3xl font-medium tracking-tight">ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
                <div class="flex flex-wrap gap-x-6 gap-y-1 text-slate-300 text-xs md:sm mt-2 font-light">
                    <p>é¡§å®¢å: <span class="clientNameLabel font-bold text-white">ã”ç›¸è«‡è€…æ§˜</span></p>
                    <p>ä½œæˆæ—¥: <span class="todayDateLabel"></span></p>
                </div>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="openModal('loadModal')" class="bg-white/10 hover:bg-white/20 text-white text-xs px-4 py-2 rounded-lg transition border border-white/30">èª­è¾¼</button>
                <button onclick="openModal('saveModal')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-6 py-2 rounded-lg font-bold shadow-lg transition">ä¿å­˜</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-slate-50 p-4 border-b flex flex-wrap gap-4 items-center no-print">
            <div class="flex bg-white rounded-xl p-1 shadow-sm border items-center">
                <span class="text-[10px] px-3 text-slate-400 font-bold border-r mr-1">è¡¨ç¤ºåˆ‡æ›¿</span>
                <span class="px-4 py-1.5 text-xs font-bold text-slate-700">1å¹´ã”ã¨å›ºå®š</span>
            </div>
            <div class="flex bg-white rounded-xl p-1 shadow-sm border items-center">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">å½¢å¼</span>
                <button id="chartLine" onclick="setChartType('line')" class="toggle-btn active px-4 py-1.5 text-xs rounded-lg transition font-medium">è³‡ç”£æ¨ç§»</button>
                <button id="chartPie" onclick="setChartType('pie')" class="toggle-btn px-4 py-1.5 text-xs rounded-lg transition font-medium">åæ”¯æ§‹æˆ</button>
            </div>
            <div id="pieYearSelectorWrapper" class="hidden flex bg-white rounded-xl p-1 shadow-sm border items-center transition-all duration-300">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">å‚ç…§å¹´</span>
                <select id="chartYearSelector" onchange="updateSimulation()" class="text-xs px-4 py-1.5 rounded-lg border-none outline-none font-medium bg-transparent"></select>
            </div>
            <div class="ml-auto">
                <button onclick="openModal('configModal')" class="bg-[#002D5B] text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-slate-800 transition shadow-lg flex items-center">
                    âš™ï¸ è©³ç´°è¨­å®šãƒ‘ãƒãƒ«
                </button>
            </div>
        </div>

        <div class="p-4 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
                <div class="bg-slate-50 border-l-4 border-[#002D5B] p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">æœŸé–“</p><p class="text-xl font-bold text-slate-700" id="summaryDuration">---</p></div>
                <div class="bg-slate-50 border-l-4 border-emerald-600 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">åœŸåœ°å»ºç‰©</p><p class="text-xl font-bold text-slate-700" id="summaryProperty">Â¥0</p></div>
                <div class="bg-slate-50 border-l-4 border-amber-500 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">æƒ³å®šåˆ©å›ã‚Š</p><p class="text-xl font-bold text-slate-700" id="summaryYield">0%</p></div>
                <div class="bg-slate-50 border-l-4 border-rose-600 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">ãƒ­ãƒ¼ãƒ³å€Ÿå…¥</p><p class="text-xl font-bold text-slate-700" id="summaryLoan">Â¥0</p></div>
            </div>

            <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm mb-12">
                <h3 id="chartTitle" class="text-sm font-bold text-slate-600 flex items-center mb-6"><span class="w-1.5 h-4 bg-[#002D5B] mr-2 rounded-full"></span>å°†æ¥ã®é‡‘èè³‡ç”£æ®‹é«˜æ¨ç§»</h3>
                <div class="chart-container" style="position: relative; height: 350px;"><canvas id="mainChart"></canvas></div>
            </div>

            <div class="overflow-x-auto border border-slate-200 rounded-2xl shadow-xl bg-white">
                <table class="w-full text-left border-collapse text-xs md:text-sm" id="cfTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody" class="font-medium text-slate-600"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-slate-50 p-8 border-t flex flex-col md:flex-row justify-end items-center gap-4 no-print">
            <button onclick="prepareAndPrintAssets()" class="bg-[#002D5B] text-white px-8 py-3 rounded-xl font-bold shadow-xl hover:scale-105 transition transform">
                è³‡ç”£æ¨ç§»ãƒ¬ãƒãƒ¼ãƒˆPDFã‚’å‡ºåŠ›
            </button>
            <button onclick="prepareAndPrintBreakdown()" class="bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold shadow-xl hover:scale-105 transition transform">
                å…¨åæ”¯æ§‹æˆãƒ¬ãƒãƒ¼ãƒˆPDFã‚’å‡ºåŠ›
            </button>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="configModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-8 border-b pb-4 text-[#002D5B]">ğŸ“ è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 shadow-inner">
                        <h3 class="font-bold text-orange-900 mb-4 flex items-center">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ãƒ»æœŸé–“è¨­å®š</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold block mb-1">æœŸé–“ (å¹´)</label><input type="number" id="duration" value="50" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                            <div><label class="text-[10px] font-bold block mb-1">æœ¬äººå¹´é½¢</label><input type="number" id="baseAge" value="35" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold block mb-1">é…å¶è€…å¹´é½¢</label><input type="number" id="spouseAge" value="32" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                            <div>
                                <label class="text-[10px] font-bold block mb-1">å­ä¾›ã®äººæ•°</label>
                                <select id="childCount" class="w-full border border-black rounded p-2 text-center" onchange="toggleChildInputs(); updateSimulation();">
                                    <option value="0">0äºº</option><option value="1">1äºº</option><option value="2">2äºº</option><option value="3" selected>3äºº</option>
                                </select>
                            </div>
                        </div>
                        <div id="childAgesWrapper" class="grid grid-cols-3 gap-2">
                            <div id="c1_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­1</label><input type="number" id="child1Age" value="5" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                            <div id="c2_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­2</label><input type="number" id="child2Age" value="2" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                            <div id="c3_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­3</label><input type="number" id="child3Age" value="0" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 shadow-inner">
                        <h3 class="font-bold text-blue-900 mb-4">ğŸ  ä½å®…ãƒ»å€Ÿå…¥è¨ˆç”»</h3>
                        <div class="space-y-4">
                            <div><label class="text-xs font-bold block">ç‰©ä»¶ä¾¡æ ¼ (ä¸‡)</label><input type="number" id="propertyTotal" value="4500" class="w-full border border-black rounded-xl p-3 text-lg font-bold text-center" onchange="updateSimulation()"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold block">å€Ÿå…¥ (ä¸‡)</label><input type="number" id="loanAmount" value="4000" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                                <div><label class="text-[10px] font-bold block">é‡‘åˆ© (%)</label><input type="number" id="loanRate" value="1.0" step="0.1" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold block">è¿”æ¸ˆæœŸé–“ (å¹´)</label><input type="number" id="loanYears" value="35" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                                <div><label class="text-[10px] font-bold block">è¦ªã®æ´åŠ© (ä¸‡)</label><input type="number" id="parentSupport" value="0" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                            </div>
                            <div class="p-2 bg-white rounded border text-xs text-center font-bold">å¹´é–“è¿”æ¸ˆè©¦ç®—ï¼šÂ¥<span id="calcLoanRepay">0</span>ä¸‡</div>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-emerald-50 p-6 rounded-2xl border border-emerald-100 shadow-inner">
                        <h3 class="font-bold text-emerald-900 mb-4">ğŸ“ˆ é‹ç”¨ãƒ»åˆæœŸè³‡ç”£</h3>
                        <div><label class="text-[10px] font-bold block">æƒ³å®šåˆ©å›ã‚Š (%)</label><input type="number" id="investRate" value="3.0" step="0.1" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                        <div class="mt-8 pt-4 border-t border-emerald-200">
                            <label class="text-xs font-bold block mb-3 text-emerald-800">é–‹å§‹æ™‚è³‡ç”£</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[9px] block">ç¾é‡‘ (ä¸‡)</label><input type="number" id="currentCash" value="1000" class="w-full border border-black rounded p-2 text-center" onchange="syncTableFromModal('currentCash_T', this.value); updateSimulation();"></div>
                                <div><label class="text-[9px] block">æŠ•è³‡ (ä¸‡)</label><input type="number" id="currentInvest" value="300" class="w-full border border-black rounded p-2 text-center" onchange="syncTableFromModal('currentInvest_T', this.value); updateSimulation();"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-10 pt-6 border-t flex justify-end"><button onclick="closeModal('configModal'); updateSimulation();" class="bg-[#002D5B] text-white px-16 py-3 rounded-2xl font-bold">è¨­å®šã‚’ä¿å­˜ã—ã¦åæ˜ </button></div>
        </div>
    </div>

    <!-- èª­è¾¼ãƒ»ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="saveModal" class="modal-backdrop"><div class="modal-content text-center"><h2 class="text-xl font-bold mb-6">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜</h2><input type="text" id="saveNameInput" class="w-full border border-black p-4 rounded-xl mb-6 text-lg text-center" placeholder="ä¾‹ï¼šãƒ†ã‚¹ãƒˆæ§˜ 2025å¹´æ¡ˆ"><div class="flex justify-center gap-3"><button onclick="closeModal('saveModal')" class="px-8 py-2 text-slate-400">é–‰ã˜ã‚‹</button><button onclick="savePlan()" class="bg-emerald-600 text-white px-10 py-2 rounded-xl font-bold">ä¿å­˜å®Ÿè¡Œ</button></div></div></div>
    <div id="loadModal" class="modal-backdrop"><div class="modal-content"><h2 class="text-xl font-bold mb-6">ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2><div id="planList" class="space-y-3 mb-6 max-h-96 overflow-y-auto"></div><div class="flex justify-end"><button onclick="closeModal('loadModal')" class="px-6 py-2 border rounded-lg">é–‰ã˜ã‚‹</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDr8lWJp-dHftPPBNvlke28r5-NdUyngnI", authDomain: "my-cashflow-sim.firebaseapp.com", projectId: "my-cashflow-sim", storageBucket: "my-cashflow-sim.firebasestorage.app", messagingSenderId: "520084319258", appId: "1:520084319258:web:747fc1c64302b2ace935a3", measurementId: "G-200LZFT53K" };
        const appId = "cashflow-sim-storage"; let db, auth, currentUser = null;
        const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
        
        onAuthStateChanged(auth, (u) => { currentUser = u; });
        try { signInAnonymously(auth); } catch(e) { console.error("Firebase Auth Error", e); }

        window.savePlan = async () => {
            const name = document.getElementById('saveNameInput').value.trim(); if (!name) return;
            window.showToast("ä¿å­˜ä¸­...");
            try {
                const config = { duration: document.getElementById('duration').value, baseAge: document.getElementById('baseAge').value, spouseAge: document.getElementById('spouseAge').value, childCount: document.getElementById('childCount').value, child1Age: document.getElementById('child1Age').value, child2Age: document.getElementById('child2Age').value, child3Age: document.getElementById('child3Age').value, propertyTotal: document.getElementById('propertyTotal').value, currentCash: document.getElementById('currentCash').value, currentInvest: document.getElementById('currentInvest').value, loanAmount: document.getElementById('loanAmount').value, loanRate: document.getElementById('loanRate').value, loanYears: document.getElementById('loanYears').value, investRate: document.getElementById('investRate').value, parentSupport: document.getElementById('parentSupport').value };
                const data = { name, config, updatedAt: serverTimestamp(), incomes: Array.from(document.querySelectorAll('.income-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })), expenses: Array.from(document.querySelectorAll('.expense-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })), memos: Array.from(document.querySelectorAll('.memo-input')).map(el => el.value) };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', encodeURIComponent(name)), data);
                window.showToast("ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ"); closeModal('saveModal'); document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = name);
            } catch(e) { window.showToast("ä¿å­˜å¤±æ•—: " + e.message); }
        };

        window.loadPlansList = async () => {
            const listArea = document.getElementById('planList'); if(!listArea) return;
            listArea.innerHTML = 'èª­è¾¼ä¸­...';
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scenarios'));
                listArea.innerHTML = snap.empty ? 'ãƒ‡ãƒ¼ã‚¿ãªã—' : '';
                snap.forEach(d => {
                    const p = d.data(); const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-4 border border-black rounded-xl hover:bg-blue-50 cursor-pointer mb-2";
                    item.innerHTML = `<div class="flex-grow" onclick="window.fetchAndLoadPlan('${d.id}')"><b>${p.name}</b></div><button onclick="window.deletePlan('${d.id}')" class="text-rose-500 text-xs px-2 py-1">å‰Šé™¤</button>`;
                    listArea.appendChild(item);
                });
            } catch(e) { listArea.innerHTML = 'èª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + e.message; }
        };

        window.fetchAndLoadPlan = async (id) => {
            window.showToast("èª­è¾¼ä¸­...");
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id));
                if (!snap.exists()) return;
                const p = snap.data(); Object.keys(p.config).forEach(k => { const el = document.getElementById(k); if(el) el.value = p.config[k]; });
                toggleChildInputs(); initTable();
                p.incomes.forEach(i => { const el = document.querySelector(`.income-input[data-cat="${i.cat}"][data-col="${i.col}"]`); if (el) el.value = i.val; });
                p.expenses.forEach(e => { const el = document.querySelector(`.expense-input[data-cat="${e.cat}"][data-col="${e.col}"]`); if (el) el.value = e.val; });
                document.querySelectorAll('.memo-input').forEach((el, idx) => { if (p.memos[idx]) el.value = p.memos[idx]; });
                document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = p.name);
                updateSimulation(); closeModal('loadModal'); window.showToast("ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            } catch(e) { window.showToast("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };
        window.deletePlan = async (id) => { if (confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id)); window.loadPlansList(); } };
    </script>

    <script>
        let mainChart; let viewInterval = 1; let chartType = 'line';
        const expenseCats = [{id:'basicLiving', label:'åŸºæœ¬ç”Ÿæ´»è²»', def:240}, {id:'housing', label:'ä½å±…é–¢é€£è²»', def:120}, {id:'vehicle', label:'è»Šä¸¡è²»', def:30}, {id:'education', label:'æ•™è‚²è²»', def:30}, {id:'insurance', label:'ä¿é™ºæ–™', def:20}, {id:'other', label:'ãã®ä»–ã®æ”¯å‡º', def:10}];
        const inPal = ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd']; 
        const exPal = ['#9f1239', '#be123c', '#e11d48', '#fb7185', '#fda4af', '#fecaca', '#fff1f2', '#ffe4e6'];

        function initDate() { const d = new Date(); document.querySelectorAll('.todayDateLabel').forEach(el => el.textContent = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`); }
        function calculatePMT(p, r, y) { if (p <= 0 || y <= 0) return 0; const ir = r / 100 / 12; const n = y * 12; if (ir === 0) return (p / y); return ((p * ir * Math.pow(1 + ir, n)) / (Math.pow(1 + ir, n) - 1)) * 12; }
        function safeSetText(id, txt) { const el = document.getElementById(id); if(el) el.textContent = txt; }
        function syncTableFromModal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function syncTableInputs() { const cVal = document.getElementById('currentCash').value; const ctVal = document.getElementById('currentCash_T'); if(ctVal) ctVal.value = cVal; const iVal = document.getElementById('currentInvest').value; const itVal = document.getElementById('currentInvest_T'); if(itVal) itVal.value = iVal; }
        
        function toggleChildInputs() { 
            const countEl = document.getElementById('childCount');
            if(!countEl) return;
            const countNum = parseInt(countEl.value); 
            document.getElementById('c1_wrap').style.display = countNum >= 1 ? 'block' : 'none'; 
            document.getElementById('c2_wrap').style.display = countNum >= 2 ? 'block' : 'none'; 
            document.getElementById('c3_wrap').style.display = countNum >= 3 ? 'block' : 'none'; 
        }

        function setChartType(type) { 
            chartType = type; document.getElementById('chartLine').classList.toggle('active', type === 'line'); document.getElementById('chartPie').classList.toggle('active', type === 'pie');
            document.getElementById('pieYearSelectorWrapper').style.display = (type === 'pie') ? 'flex' : 'none';
            updateSimulation(); 
        }

        function initTable() {
            const dur = parseInt(document.getElementById('duration')?.value || 50);
            const colsArr = Array.from({length: dur + 1}, (_, i) => i);
            const yearSelector = document.getElementById('chartYearSelector');
            if(yearSelector) {
                const currentVal = yearSelector.value;
                yearSelector.innerHTML = colsArr.map(c => `<option value="${c}">${c === 0 ? 'ç¾åœ¨' : c + 'å¹´å¾Œ'}</option>`).join('');
                if(currentVal && currentVal <= dur) yearSelector.value = currentVal;
            }
            const thead = document.getElementById('tableHeader');
            thead.innerHTML = `<tr class="bg-slate-800 text-white shadow-md"><th class="p-5 input-col text-slate-800">é …ç›®</th>${colsArr.map(c => `<th class="p-5 text-center font-bold">${c===0?'ç¾åœ¨':c+'å¹´å¾Œ'}</th>`).join('')}</tr>`;
            const tbody = document.getElementById('tableBody');
            let h = `<tr class="bg-amber-50/20"><td class="p-4 input-col font-bold border-b text-[11px]">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</td>${colsArr.map((_, i) => `<td class="p-2 border-b text-center"><textarea class="memo-input event-memo" data-col="${i}" oninput="updateSimulation()" placeholder="ãƒ¡ãƒ¢"></textarea></td>`).join('')}</tr>`;
            h += `<tr class="bg-slate-50"><td class="p-4 input-col font-bold border-b">æœ¬äººå¹´é½¢</td>${colsArr.map((_, i) => `<td class="p-3 border-b text-center font-bold text-slate-800" data-type="ageSelf" data-col="${i}">---</td>`).join('')}</tr>`;
            h += `<tr class="bg-slate-50/50"><td class="p-4 input-col font-bold border-b">é…å¶è€…å¹´é½¢</td>${colsArr.map((_, i) => `<td class="p-3 border-b text-center text-slate-500" data-type="ageSpouse" data-col="${i}">---</td>`).join('')}</tr>`;
            h += `<tr class="bg-slate-50/50 border-b-4"><td class="p-4 input-col font-bold text-[11px]">å®¶æ—ã®å¹´é½¢</td>${colsArr.map((_, i) => `<td class="p-3 border-b text-center text-[10px]" data-type="ageChildren" data-col="${i}">---</td>`).join('')}</tr>`;
            
            h += `<tr class="bg-blue-50 font-bold text-income-total"><td class="p-4 input-col border-b">ã€åå…¥åˆè¨ˆã€‘</td>${colsArr.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalIncome" data-col="${i}">0</td>`).join('')}</tr>`;
            h += `<tr><td class="p-3 input-col pl-8 border-b text-xs">æœ¬äººåå…¥</td>${colsArr.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="self" data-col="${i}" value="500" oninput="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            h += `<tr><td class="p-3 input-col pl-8 border-b text-xs">é…å¶è€…åå…¥</td>${colsArr.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="spouse" data-col="${i}" value="150" oninput="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            h += `<tr><td class="p-3 input-col pl-8 border-b font-bold text-blue-600 text-xs">ä½å®…ãƒ­ãƒ¼ãƒ³å€Ÿå…¥</td>${colsArr.map((_, i) => `<td class="p-2 border-b text-center font-bold" data-type="loanIn" data-col="${i}">0</td>`).join('')}</tr>`;
            h += `<tr><td class="p-3 input-col pl-8 border-b text-xs">ä¸€æ™‚åå…¥/ä»–</td>${colsArr.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="tempInc" data-col="${i}" value="0" onchange="updateSimulation()"></td>`).join('')}</tr>`;
            
            h += `<tr class="bg-rose-50 font-bold text-expense-total"><td class="p-4 input-col border-b">ã€æ”¯å‡ºåˆè¨ˆã€‘</td>${colsArr.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalExpense" data-col="${i}">0</td>`).join('')}</tr>`;
            h += `<tr><td class="p-2 input-col pl-8 border-b font-bold text-rose-600 text-[10px]">åœŸåœ°å»ºç‰©(è‡ªå·±é‡‘)</td>${colsArr.map((_, i) => `<td class="p-1 border-b text-center font-bold text-rose-600" data-type="propertyOut" data-col="${i}">0</td>`).join('')}</tr>`;
            h += `<tr><td class="p-2 input-col pl-8 border-b font-bold text-rose-600 text-[10px]">ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ</td>${colsArr.map((_, i) => `<td class="p-1 border-b text-center" data-type="loanOut" data-col="${i}">0</td>`).join('')}</tr>`;
            expenseCats.forEach(cat => { h += `<tr><td class="p-2 input-col pl-8 border-b text-xs">${cat.label}</td>${colsArr.map((_, i) => `<td class="p-1 border-b"><input type="number" class="table-input expense-input" data-cat="${cat.id}" data-col="${i}" value="${cat.def}" onchange="updateSimulation()"></td>`).join('')}</tr>`; });
            
            h += `<tr class="asset-total-row font-bold text-white border-t-2"><td class="p-4 input-col bg-emerald-900 text-white border-b text-[11px]">ã€è³‡ç”£åˆè¨ˆã€‘</td>${colsArr.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalAssets" data-col="${i}">0</td>`).join('')}</tr>`;
            h += `<tr class="asset-sub-row text-xs"><td class="p-2 input-col pl-8 border-b">å†…ï¼šç¾é‡‘ãƒ»é è²¯é‡‘</td><td class="p-2 border-b text-center"><input type="number" id="currentCash_T" class="table-input" onchange="syncAndRefresh('currentCash', this.value)"></td>${colsArr.slice(1).map((_, i) => `<td class="p-2 border-b text-center" data-type="assetCash" data-col="${i+1}">0</td>`).join('')}</tr>`;
            h += `<tr class="asset-sub-row border-b-2 text-xs"><td class="p-2 input-col pl-8 border-b font-medium text-emerald-700">å†…ï¼šæŠ•è³‡è³‡ç”£</td><td class="p-2 border-b text-center"><input type="number" id="currentInvest_T" class="table-input" onchange="syncAndRefresh('currentInvest', this.value)"></td>${colsArr.slice(1).map((_, i) => `<td class="p-2 border-b text-center text-emerald-700" data-type="assetInvest" data-col="${i+1}">0</td>`).join('')}</tr>`;
            
            h += `<tr class="bg-slate-100 font-bold"><td class="p-4 input-col bg-slate-200 border-b">å¹´é–“åæ”¯(Net)</td>${colsArr.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="balance" data-col="${i}">0</td>`).join('')}</tr>`;
            tbody.innerHTML = h; syncTableInputs();
        }

        function handleIncomePropagate(el) {
            const cat = el.dataset.cat; const val = el.value; const colIdx = parseInt(el.dataset.col);
            document.querySelectorAll(`.income-input[data-cat="${cat}"]`).forEach(input => { if (parseInt(input.dataset.col) > colIdx) input.value = val; });
        }

        function syncAndRefresh(id, val) { const el = document.getElementById(id); if (el) el.value = val; updateSimulation(); }

        window.updateSimulation = () => {
            const baseAge = parseInt(document.getElementById('baseAge')?.value || 35);
            const spouseAge = parseInt(document.getElementById('spouseAge')?.value || 32);
            const duration = parseInt(document.getElementById('duration')?.value || 50);
            const childCount = parseInt(document.getElementById('childCount')?.value || 0);
            const c1 = parseInt(document.getElementById('child1Age')?.value || 0);
            const c2 = parseInt(document.getElementById('child2Age')?.value || 0);
            const c3 = parseInt(document.getElementById('child3Age')?.value || 0);
            const propTotal = parseFloat(document.getElementById('propertyTotal')?.value || 0);
            const initCash = parseFloat(document.getElementById('currentCash')?.value || 0);
            const initInvest = parseFloat(document.getElementById('currentInvest')?.value || 0);
            const loanAmt = parseFloat(document.getElementById('loanAmount')?.value || 0);
            const loanRate = parseFloat(document.getElementById('loanRate')?.value || 1.0);
            const loanYears = parseInt(document.getElementById('loanYears')?.value || 35);
            const invRate = parseFloat(document.getElementById('investRate')?.value || 3.0) / 100;
            const parentSupport = parseFloat(document.getElementById('parentSupport')?.value || 0);

            const loanRepaymentYear = calculatePMT(loanAmt, loanRate, loanYears);
            safeSetText('calcLoanRepay', Math.floor(loanRepaymentYear).toLocaleString());
            safeSetText('summaryDuration', `${baseAge+duration}æ­³ã¾ã§ (${duration}å¹´)`);
            safeSetText('summaryLoan', `Â¥${loanAmt.toLocaleString()}ä¸‡`);
            safeSetText('summaryYield', `${(invRate*100).toFixed(1)}%`);
            safeSetText('summaryProperty', `Â¥${propTotal.toLocaleString()}ä¸‡`);

            let runC = initCash + parentSupport; let runI = initInvest; let lBal = loanAmt;
            const yearlyDataArr = [];
            for (let year = 0; year <= duration; year++) {
                let tInc = 0; document.querySelectorAll(`.income-input[data-col="${year}"]`).forEach(el => tInc += parseFloat(el.value || 0));
                const lIn = (year === 0) ? loanAmt : 0;

                const propertyOut = (year === 0) ? Math.max(0, propTotal - loanAmt) : 0;
                let tExp = 0; document.querySelectorAll(`.expense-input[data-col="${year}"]`).forEach(el => tExp += parseFloat(el.value || 0));
                tExp += propertyOut;
                
                let curL = 0; if (year > 0 && year <= loanYears && lBal > 0) { const iY = lBal * (loanRate / 100); curL = Math.min(loanRepaymentYear, lBal + iY); lBal = Math.max(0, lBal + iY - curL); }
                tExp += curL; if (year > 0) runI *= (1 + invRate);
                
                const bal = Math.floor(tInc) - Math.floor(tExp); 
                
                const tA = runC + runI;
                
                const sel = (type) => document.querySelector(`[data-type="${type}"][data-col="${year}"]`);
                if(sel('ageSelf')) sel('ageSelf').textContent = `${baseAge+year}æ­³`;
                if(sel('ageSpouse')) sel('ageSpouse').textContent = `${spouseAge+year}æ­³`;
                const cInfo = []; if(childCount>=1) cInfo.push(c1+year); if(childCount>=2) cInfo.push(c2+year); if(childCount>=3) cInfo.push(c3+year);
                if(sel('ageChildren')) sel('ageChildren').textContent = cInfo.join(', ') || '---';
                if(sel('totalIncome')) sel('totalIncome').textContent = Math.floor(tInc).toLocaleString();
                if(sel('totalExpense')) sel('totalExpense').textContent = Math.floor(tExp).toLocaleString();
                if(sel('loanIn')) sel('loanIn').textContent = lIn.toLocaleString();
                if(sel('propertyOut')) sel('propertyOut').textContent = propertyOut.toLocaleString();
                if(sel('loanOut')) sel('loanOut').textContent = Math.floor(curL).toLocaleString();
                if (year > 0) { if(sel('assetCash')) sel('assetCash').textContent = Math.floor(runC).toLocaleString(); if(sel('assetInvest')) sel('assetInvest').textContent = Math.floor(runI).toLocaleString(); }
                
                const aEl = sel('totalAssets'); if(aEl) { aEl.textContent = Math.floor(tA).toLocaleString(); aEl.className = `p-4 border-b text-center font-bold ${tA>=0?'text-emerald-700':'text-rose-700'}`; }
                const bEl = sel('balance'); if(bEl) { bEl.textContent = (bal>=0?'+':'') + bal.toLocaleString(); bEl.className = `p-4 border-b text-center font-bold ${bal>=0?'text-emerald-600':'text-rose-600'}`; }

                yearlyDataArr.push({ year, ageS: baseAge+year, ageSp: spouseAge+year, cAges: cInfo.join(', '), memo: document.querySelector(`.event-memo[data-col="${year}"]`)?.value || "", income: tInc, expense: tExp, cash: runC, invest: runI, assets: tA, selfInc: parseFloat(document.querySelector(`.income-input[data-cat="self"][data-col="${year}"]`)?.value || 0), spouseInc: parseFloat(document.querySelector(`.income-input[data-cat="spouse"][data-col="${year}"]`)?.value || 0), loanIn: lIn, tempInc: parseFloat(document.querySelector(`.income-input[data-cat="tempInc"][data-col="${year}"]`)?.value || 0), propertyOut: propertyOut, loanOut: curL, exps: expenseCats.map(c => ({ label: c.label, val: parseFloat(document.querySelector(`.expense-input[data-cat="${c.id}"][data-col="${year}"]`)?.value || 0) })) });
                
                runC += bal;
            }
            window.lastData = yearlyDataArr; renderCharts(yearlyDataArr);
        };

        function renderCharts(data) {
            const ctx = document.getElementById('mainChart').getContext('2d'); if (mainChart) mainChart.destroy();
            const yrSel = parseInt(document.getElementById('chartYearSelector')?.value || 0);
            const d = data.find(i => i.year === yrSel) || data[0];
            if (chartType === 'line') {
                const labels = data.filter((_,i) => i % 2 === 0).map(i => `${i.ageS}æ­³`);
                const assets = data.filter((_,i) => i % 2 === 0).map(i => i.assets);
                mainChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'ç·è³‡ç”£', data: assets, borderColor: '#002D5B', fill: true, tension: 0.3 }] }, options: { maintainAspectRatio: false, animation: false } });
            } else {
                const ins = [{ label: 'æœ¬äºº', val: d.selfInc }, { label: 'é…', val: d.spouseInc }, { label: 'å€Ÿ', val: d.loanIn }, { label: 'ä»–', val: d.tempInc }].filter(i => i.val > 0);
                const exs = [{ label: 'ç‰©', val: d.propertyOut }, { label: 'ãƒ­', val: d.loanOut }, ...d.exps.map(e=>({label:e.label, v:e.val}))].filter(i => i.v > 0);
                mainChart = new Chart(ctx, { type: 'doughnut', data: { labels: [...ins, ...exs].map(i => i.label || i.l), datasets: [{ data: [...ins, ...exs].map(i => i.val || i.v), backgroundColor: [...ins.map((_,i)=>inPal[i%inPal.length]), ...exs.map((_,i)=>exPal[i%exPal.length])], borderWidth: 1 }] }, options: { maintainAspectRatio: false, animation: false, plugins: { legend: { position: 'right' } } } });
            }
        }

        async function prepareAndPrintAssets() {
            window.showToast("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­...");
            const data = window.lastData; if(!data) return;
            const printArea = document.getElementById('printOnlyArea'); printArea.innerHTML = '';
            setChartType('line'); await new Promise(r => setTimeout(r, 800));
            const lineImg = mainChart.toBase64Image();
            setChartType('pie'); await new Promise(r => setTimeout(r, 800));
            const pieImg = mainChart.toBase64Image();

            printArea.innerHTML = `
                <div class="print-cover"><h1>ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å ±å‘Šæ›¸</h1><p>é¡§å®¢åï¼š${document.querySelector('.clientNameLabel').innerText} æ§˜</p><p>ä½œæˆæ—¥ï¼š${new Date().toLocaleDateString('ja-JP')}</p></div>
                <div class="page-break">
                    <h2>1. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦ã¨çµæœåˆ†æã‚°ãƒ©ãƒ•</h2>
                    <div class="print-summary-grid">
                        <div class="print-summary-item"><label>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“</label><span>${document.getElementById('summaryDuration').innerText}</span></div>
                        <div class="print-summary-item"><label>åœŸåœ°å»ºç‰©ç·é¡</label><span>${document.getElementById('summaryProperty').innerText}</span></div>
                        <div class="print-summary-item"><label>å€Ÿå…¥é¡</label><span>${document.getElementById('summaryLoan').innerText}</span></div>
                        <div class="print-summary-item"><label>åˆ©å›ã‚Š</label><span>${document.getElementById('summaryYield').innerText}</span></div>
                    </div>
                    <div class="print-chart-row">
                        <div class="print-chart-box"><h3>å°†æ¥è³‡ç”£æ®‹é«˜ã®æ¨ç§»</h3><img src="${lineImg}" class="print-chart-img"></div>
                        <div class="print-chart-box"><h3>ç¾çŠ¶ã®åæ”¯å†…è¨³</h3><img src="${pieImg}" class="print-chart-img"></div>
                    </div>
                </div>
            `;

            const chunkSize = 15;
            for(let p = 0; p < Math.ceil(data.length / chunkSize); p++) {
                const chunk = data.slice(p * chunkSize, (p + 1) * chunkSize);
                const table = document.createElement('table'); if (p < Math.ceil(data.length / chunkSize) - 1) table.className = "page-break";
                let tHtml = `<tr class="bg-slate-800 text-white"><th class="print-label-col">é …ç›®</th>${chunk.map(d => `<th>${d.year===0?'ç¾åœ¨':d.year+'å¹´å¾Œ'}</th>`).join('')}</tr>`;
                tHtml += `<tr><td class="print-label-col">å®¶æ—å¹´é½¢(æœ¬äºº/é…/å­)</td>${chunk.map(d => `<td>${d.ageS}/${d.ageSp}/${d.cAges}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-header"><td>ã€åå…¥åˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.income).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-row"><td class="print-sub-label">æœ¬äººåå…¥</td>${chunk.map(d => `<td>${Math.floor(d.selfInc).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-row"><td class="print-sub-label">é…å¶è€…åå…¥</td>${chunk.map(d => `<td>${Math.floor(d.spouseInc).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-expense-header"><td>ã€æ”¯å‡ºåˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.expense).toLocaleString()}</td>`).join('')}</tr>`;
                expenseCats.forEach((cat, idx) => { tHtml += `<tr class="print-expense-row"><td class="print-sub-label">${cat.label}</td>${chunk.map(d => `<td>${Math.floor(d.exps[idx].val).toLocaleString()}</td>`).join('')}</tr>`; });
                tHtml += `<tr class="print-asset-header"><td>ã€è³‡ç”£åˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.assets).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-asset-row"><td class="print-sub-label">å†…ï¼šç¾é‡‘ãƒ»é é‡‘</td>${chunk.map(d => `<td>${Math.floor(d.cash).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-asset-row"><td class="print-sub-label">å†…ï¼šæŠ•è³‡è³‡ç”£</td>${chunk.map(d => `<td>${Math.floor(d.invest).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-balance-row"><td>å¹´é–“åæ”¯(Net)</td>${chunk.map(d => `<td>${(Math.floor(d.income) - Math.floor(d.expense)).toLocaleString()}</td>`).join('')}</tr>`;
                table.innerHTML = tHtml; printArea.appendChild(table);
            }
            setTimeout(() => { window.print(); window.showToast("ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ"); }, 1000);
        }

        async function prepareAndPrintBreakdown() {
            window.showToast("å…¨å¹´åº¦ã®å††ã‚°ãƒ©ãƒ•ã‚’é †æ¬¡ç”Ÿæˆä¸­...");
            const data = window.lastData; if(!data) return;
            const printArea = document.getElementById('printOnlyArea'); printArea.innerHTML = '';
            printArea.innerHTML = `<div class="print-cover"><h1>å¹´åº¦åˆ¥ãƒ»åæ”¯è©³ç´°ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ¬ãƒãƒ¼ãƒˆ</h1><p>é¡§å®¢åï¼š${document.querySelector('.clientNameLabel').innerText} æ§˜</p></div><div class="page-break"><h2>å…¨æœŸé–“ã®åæ”¯å†…è¨³å††ã‚°ãƒ©ãƒ•ä¸€è¦§</h2><div class="pie-grid" id="piePrintGrid"></div></div>`;
            const grid = document.getElementById('piePrintGrid');
            const hCanvas = document.getElementById('hiddenPieCanvas'); const hCtx = hCanvas.getContext('2d');
            const tempPie = new Chart(hCtx, { type: 'doughnut', options: { animation: false, responsive: false, plugins: { legend: { display: false } } } });
            for (const d of data) {
                const ins = [{ label: 'æœ¬', v: d.selfInc }, { label: 'é…', v: d.spouseInc }, { label: 'å€Ÿ', v: d.loanIn }, { label: 'ä»–', v: d.tempInc }].filter(i => i.v > 0);
                const exs = [{ label: 'ç‰©', v: d.propertyOut }, { label: 'ãƒ­', v: d.loanOut }, ...d.exps.map(e=>({label:e.label, v:e.val}))].filter(i => i.v > 0);
                tempPie.data = { labels: [...ins, ...exs].map(i => i.label || i.l), datasets: [{ data: [...ins, ...exs].map(i => i.val || i.v), backgroundColor: [...ins.map((_,i)=>inPal[i%inPal.length]), ...exs.map((_,i)=>exPal[i%exPal.length])], borderWidth: 1 }] };
                tempPie.update();
                await new Promise(r => setTimeout(r, 60));
                const img = tempPie.toBase64Image();
                const item = document.createElement('div'); item.className = "pie-item";
                item.innerHTML = `<p>${d.year === 0 ? 'ç¾åœ¨' : d.year + 'å¹´å¾Œ'} (${d.ageS}æ­³)</p><img src="${img}">`;
                grid.appendChild(item);
            }
            setTimeout(() => { window.print(); window.showToast("åæ”¯ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ"); }, 1000);
        }

        window.openModal = (id) => { 
            const el = document.getElementById(id); 
            if(el) el.style.display = 'flex'; 
            if(id === 'loadModal') window.loadPlansList();
        };
        window.closeModal = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'none'; };
        window.showToast = (msg) => { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 4000); };
        
        document.addEventListener('DOMContentLoaded', () => { initDate(); toggleChildInputs(); initTable(); updateSimulation(); });
    </script>
</body>
</html>