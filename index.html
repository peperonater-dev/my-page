<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æå ±å‘Šæ›¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        :root {
            --consulting-navy: #002D5B;
            --consulting-gold: #A68966;
            --consulting-gray: #F4F7F9;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        /* --- å°åˆ·ãƒ»PDFä¿å­˜ç”¨è¨­å®š --- */
        #printOnlyArea { display: none; }

        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            .no-print { display: none !important; }
            #reportArea { display: none !important; }
            #printOnlyArea { display: block !important; }
            
            body { background-color: white !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .page-break { page-break-after: always; }
            
            /* ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç´™ */
            .print-cover {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background-color: var(--consulting-navy) !important;
                color: white !important;
                text-align: center;
                -webkit-print-color-adjust: exact;
            }
            .print-cover h1 { font-size: 32px; margin-bottom: 20px; border-bottom: 2px solid white; padding-bottom: 10px; width: 80%; }
            .print-cover p { font-size: 18px; margin: 5px; }

            h2 { font-size: 16px !important; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: var(--consulting-navy); border-left: 5px solid var(--consulting-navy); padding-left: 10px; }

            table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 6.5px !important; /* å†…è¨³ãŒå¤šã„ã®ã§å°‘ã—å°ã•ã */
                margin-bottom: 25px;
                table-layout: fixed;
            }
            th, td {
                border: 1px solid #cbd5e1 !important;
                padding: 3px 1px !important;
                text-align: center;
            }
            .bg-slate-800 { background-color: #1e293b !important; color: white !important; -webkit-print-color-adjust: exact; }
            
            /* PDFå†…è¨³è¡Œã®è‰²åˆ†ã‘ */
            .print-income-header { background-color: #eff6ff !important; color: #1e40af !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-income-row { background-color: #f8fafc !important; -webkit-print-color-adjust: exact; }
            .print-expense-header { background-color: #fff1f2 !important; color: #9f1239 !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-expense-row { background-color: #fffafb !important; -webkit-print-color-adjust: exact; }
            .print-asset-header { background-color: #ecfdf5 !important; color: #064e3b !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-asset-row { background-color: #f0fdf4 !important; -webkit-print-color-adjust: exact; }
            
            .print-label-col { width: 120px !important; font-weight: bold; text-align: left !important; padding-left: 5px !important; background-color: #f8fafc !important; }
            .print-sub-label { padding-left: 15px !important; font-weight: normal; }

            .print-chart-img {
                width: 100%;
                max-height: 280px;
                object-fit: contain;
                margin: 20px 0;
            }

            /* å††ã‚°ãƒ©ãƒ•ã‚°ãƒªãƒƒãƒ‰ */
            .pie-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-top: 10px;
            }
            .pie-item {
                text-align: center;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .pie-item img { width: 100%; max-height: 160px; object-fit: contain; }
            .pie-item p { font-size: 9px; font-weight: bold; margin-top: 5px; color: var(--consulting-navy); }
            
            .print-summary-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            .print-summary-item {
                border: 1px solid #cbd5e1;
                padding: 12px;
                border-radius: 6px;
                text-align: center;
            }
            .print-summary-item label { font-size: 8px; color: #64748b; display: block; margin-bottom: 4px; }
            .print-summary-item span { font-size: 14px; font-weight: bold; color: var(--consulting-navy); }
        }

        /* ç”»é¢UI */
        .table-input {
            width: 100%;
            text-align: center;
            background-color: #ffffff;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 4px 2px;
            font-weight: 500;
        }
        .memo-input {
            width: 100%;
            text-align: center;
            background-color: #fffbeb;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 6px;
            font-size: 11px;
            min-height: 50px;
        }
        .input-col {
            background-color: #f8fafc;
            border-right: 3px solid #64748b !important;
            min-width: 180px;
            position: sticky;
            left: 0;
            z-index: 40;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .toggle-btn.active {
            background-color: var(--consulting-navy);
            color: white;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            max-width: 1000px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* æ•°å€¤ã‚«ãƒ©ãƒ¼è¨­å®š */
        .text-income-total { color: #1d4ed8 !important; }
        .text-expense-total { color: #be123c !important; }

        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background-color: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 10px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="toastContainer" class="no-print"></div>

    <!-- å°åˆ·ç”¨ã‚¨ãƒªã‚¢ -->
    <div id="printOnlyArea"></div>

    <!-- ã‚°ãƒ©ãƒ•ç”»åƒç”Ÿæˆç”¨ã®éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div style="position: absolute; left: -9999px; top: -9999px;">
        <canvas id="hiddenPieCanvas" width="500" height="500"></canvas>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³UI -->
    <div id="reportArea" class="max-w-[1600px] mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden mb-8">
        <div class="bg-[#002D5B] p-6 md:p-8 text-white flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-widest opacity-70 mb-1">Financial Analysis Platform</p>
                <h1 class="text-xl md:text-3xl font-medium tracking-tight">ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
                <div class="flex flex-wrap gap-x-6 gap-y-1 text-slate-300 text-xs md:sm mt-2 font-light">
                    <p>é¡§å®¢å: <span class="clientNameLabel font-bold text-white">ã”ç›¸è«‡è€…æ§˜</span></p>
                    <p>ä½œæˆæ—¥: <span class="todayDateLabel"></span></p>
                </div>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="openModal('loadModal')" class="bg-white/10 hover:bg-white/20 text-white text-xs px-4 py-2 rounded-lg transition border border-white/30">èª­è¾¼</button>
                <button onclick="openModal('saveModal')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-6 py-2 rounded-lg font-bold shadow-lg transition">ä¿å­˜</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-slate-50 p-4 border-b flex flex-wrap gap-4 items-center no-print">
            <div class="flex bg-white rounded-xl p-1 shadow-sm border items-center">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">è¡¨ç¤ºå½¢å¼</span>
                <button id="chartLine" onclick="setChartType('line')" class="toggle-btn active px-4 py-1.5 text-xs rounded-lg transition font-medium">è³‡ç”£æ¨ç§»</button>
                <button id="chartPie" onclick="setChartType('pie')" class="toggle-btn px-4 py-1.5 text-xs rounded-lg transition font-medium">å…¨åæ”¯æ§‹æˆ</button>
            </div>
            <div id="pieYearSelectorWrapper" class="hidden flex bg-white rounded-xl p-1 shadow-sm border items-center transition-all duration-300">
                <span class="text-[10px] px-3 text-slate-400 font-bold uppercase border-r mr-1">å‚ç…§å¹´</span>
                <select id="chartYearSelector" onchange="updateSimulation()" class="text-xs px-4 py-1.5 rounded-lg border-none outline-none font-medium bg-transparent"></select>
            </div>
            <div class="ml-auto">
                <button onclick="openModal('configModal')" class="bg-[#002D5B] text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-slate-800 transition shadow-lg flex items-center">
                    âš™ï¸ è©³ç´°è¨­å®šãƒ‘ãƒãƒ«
                </button>
            </div>
        </div>

        <div class="p-4 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
                <div class="bg-slate-50 border-l-4 border-[#002D5B] p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">æœŸé–“</p><p class="text-xl font-bold text-slate-700" id="summaryDuration">---</p></div>
                <div class="bg-slate-50 border-l-4 border-emerald-600 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">åœŸåœ°å»ºç‰©</p><p class="text-xl font-bold text-slate-700" id="summaryProperty">Â¥0</p></div>
                <div class="bg-slate-50 border-l-4 border-amber-500 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">æƒ³å®šåˆ©å›ã‚Š</p><p class="text-xl font-bold text-slate-700" id="summaryYield">0%</p></div>
                <div class="bg-slate-50 border-l-4 border-rose-600 p-5 rounded-r-xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">å€Ÿå…¥é¡</p><p class="text-xl font-bold text-slate-700" id="summaryLoan">Â¥0</p></div>
            </div>

            <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm mb-12">
                <h3 id="chartTitle" class="text-sm font-bold text-slate-600 flex items-center mb-6"><span class="w-1.5 h-4 bg-[#002D5B] mr-2 rounded-full"></span>å°†æ¥ã®é‡‘èè³‡ç”£æ®‹é«˜æ¨ç§»</h3>
                <div class="chart-container"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto border border-slate-200 rounded-2xl shadow-xl bg-white">
                <table class="w-full text-left border-collapse text-xs md:text-sm" id="cfTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody" class="font-medium text-slate-600"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-slate-50 p-8 border-t flex flex-col md:flex-row justify-end items-center gap-4 no-print">
            <button onclick="prepareAndPrintAssets()" class="bg-[#002D5B] text-white px-10 py-4 rounded-2xl font-bold shadow-2xl hover:scale-105 transition transform">
                è³‡ç”£æ¨ç§»ãƒ¬ãƒãƒ¼ãƒˆPDFã‚’å‡ºåŠ›
            </button>
            <button onclick="prepareAndPrintBreakdown()" class="bg-emerald-700 text-white px-10 py-4 rounded-2xl font-bold shadow-2xl hover:scale-105 transition transform">
                å…¨åæ”¯æ§‹æˆPDFã‚’å‡ºåŠ›
            </button>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="configModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-8 border-b pb-4 text-[#002D5B]">ğŸ“ è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 shadow-inner">
                        <h3 class="font-bold text-orange-900 mb-4 flex items-center">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ãƒ»æœŸé–“</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold block mb-1">æœŸé–“ (å¹´)</label><input type="number" id="duration" value="50" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                            <div><label class="text-[10px] font-bold block mb-1">æœ¬äººå¹´é½¢</label><input type="number" id="baseAge" value="35" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold block mb-1">é…å¶è€…å¹´é½¢</label><input type="number" id="spouseAge" value="32" class="w-full border border-black rounded p-2 text-center" onchange="updateSimulation()"></div>
                            <div>
                                <label class="text-[10px] font-bold block mb-1">å­ä¾›ã®äººæ•°</label>
                                <select id="childCount" class="w-full border border-black rounded p-2 text-center" onchange="toggleChildInputs(); updateSimulation();">
                                    <option value="0">0äºº</option>
                                    <option value="1">1äºº</option>
                                    <option value="2">2äºº</option>
                                    <option value="3" selected>3äºº</option>
                                </select>
                            </div>
                        </div>
                        <div id="childAgesWrapper" class="grid grid-cols-3 gap-2">
                            <div id="c1_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­1</label><input type="number" id="child1Age" value="5" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                            <div id="c2_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­2</label><input type="number" id="child2Age" value="2" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                            <div id="c3_wrap"><label class="text-[9px] font-bold block mb-1 text-center">å­3</label><input type="number" id="child3Age" value="0" class="w-full border border-black rounded p-1 text-center" onchange="updateSimulation()"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 shadow-inner">
                        <h3 class="font-bold text-blue-900 mb-4">ğŸ  ä½å®…ãƒ»å€Ÿå…¥è¨ˆç”»</h3>
                        <div class="space-y-4">
                            <div><label class="text-xs font-bold block">ç‰©ä»¶ä¾¡æ ¼ (ä¸‡)</label><input type="number" id="propertyTotal" value="4500" class="w-full border border-black rounded-xl p-3 text-lg font-bold text-center" onchange="updateSimulation()"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold block">å€Ÿå…¥ (ä¸‡)</label><input type="number" id="loanAmount" value="4000" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                                <div><label class="text-[10px] font-bold block">é‡‘åˆ© (%)</label><input type="number" id="loanRate" value="1.0" step="0.1" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold block">æœŸé–“ (å¹´)</label><input type="number" id="loanYears" value="35" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                                <div><label class="text-[10px] font-bold block">æ´åŠ© (ä¸‡)</label><input type="number" id="parentSupport" value="0" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                            </div>
                            <div class="p-2 bg-white rounded border text-xs text-center font-bold">è¿”æ¸ˆè©¦ç®—ï¼šÂ¥<span id="calcLoanRepay">0</span>ä¸‡ / å¹´</div>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-emerald-50 p-6 rounded-2xl border border-emerald-100 shadow-inner">
                        <h3 class="font-bold text-emerald-900 mb-4">ğŸ“ˆ è³‡ç”£é‹ç”¨è¨­å®š</h3>
                        <div><label class="text-[10px] font-bold block">æƒ³å®šåˆ©å›ã‚Š (%)</label><input type="number" id="investRate" value="3.0" step="0.1" class="w-full border border-black rounded-lg p-2 text-center" onchange="updateSimulation()"></div>
                        <div class="mt-8 pt-4 border-t border-emerald-200">
                            <label class="text-xs font-bold block mb-3 text-emerald-800">é–‹å§‹æ™‚è³‡ç”£</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[9px] block">ç¾é‡‘ (ä¸‡)</label><input type="number" id="currentCash" value="1000" class="w-full border border-black rounded p-2 text-center" onchange="syncTableFromModal('currentCash_T', this.value); updateSimulation();"></div>
                                <div><label class="text-[9px] block">æŠ•è³‡ (ä¸‡)</label><input type="number" id="currentInvest" value="300" class="w-full border border-black rounded p-2 text-center" onchange="syncTableFromModal('currentInvest_T', this.value); updateSimulation();"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-10 pt-6 border-t flex justify-end"><button onclick="closeModal('configModal'); updateSimulation();" class="bg-[#002D5B] text-white px-16 py-3 rounded-2xl font-bold shadow-xl">è¨­å®šã‚’åæ˜ ã—ã¦é–‰ã˜ã‚‹</button></div>
        </div>
    </div>

    <!-- èª­è¾¼ãƒ»ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="saveModal" class="modal-backdrop"><div class="modal-content text-center"><h2 class="text-xl font-bold mb-6">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜</h2><input type="text" id="saveNameInput" class="w-full border border-black p-4 rounded-xl mb-6 text-lg text-center" placeholder="ä¾‹ï¼šæ—æ§˜ 2025å¹´æ¡ˆ"><div class="flex justify-center gap-3"><button onclick="closeModal('saveModal')" class="px-8 py-2 text-slate-400">é–‰ã˜ã‚‹</button><button onclick="savePlan()" class="bg-emerald-600 text-white px-10 py-2 rounded-xl font-bold shadow-lg">ä¿å­˜å®Ÿè¡Œ</button></div></div></div>
    <div id="loadModal" class="modal-backdrop"><div class="modal-content"><h2 class="text-xl font-bold mb-6">ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2><div id="planList" class="space-y-3 mb-6 max-h-96 overflow-y-auto"></div><div class="flex justify-end"><button onclick="closeModal('loadModal')" class="px-6 py-2 border rounded-lg">é–‰ã˜ã‚‹</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDr8lWJp-dHftPPBNvlke28r5-NdUyngnI", authDomain: "my-cashflow-sim.firebaseapp.com", projectId: "my-cashflow-sim", storageBucket: "my-cashflow-sim.firebasestorage.app", messagingSenderId: "520084319258", appId: "1:520084319258:web:747fc1c64302b2ace935a3", measurementId: "G-200LZFT53K" };
        const appId = "cashflow-sim-storage"; let db, auth, currentUser = null;
        const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
        onAuthStateChanged(auth, (u) => { currentUser = u; }); signInAnonymously(auth);

        window.savePlan = async () => {
            if (!currentUser) return;
            const name = document.getElementById('saveNameInput').value.trim(); if (!name) return;
            const config = { duration: document.getElementById('duration').value, baseAge: document.getElementById('baseAge').value, spouseAge: document.getElementById('spouseAge').value, childCount: document.getElementById('childCount').value, child1Age: document.getElementById('child1Age').value, child2Age: document.getElementById('child2Age').value, child3Age: document.getElementById('child3Age').value, propertyTotal: document.getElementById('propertyTotal').value, currentCash: document.getElementById('currentCash').value, currentInvest: document.getElementById('currentInvest').value, loanAmount: document.getElementById('loanAmount').value, loanRate: document.getElementById('loanRate').value, loanYears: document.getElementById('loanYears').value, investRate: document.getElementById('investRate').value, parentSupport: document.getElementById('parentSupport').value };
            const data = { name, config, updatedAt: serverTimestamp(), incomes: Array.from(document.querySelectorAll('.income-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })), expenses: Array.from(document.querySelectorAll('.expense-input')).map(el => ({ cat: el.dataset.cat, col: el.dataset.col, val: el.value })), memos: Array.from(document.querySelectorAll('.memo-input')).map(el => el.value) };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', encodeURIComponent(name)), data);
            window.showToast("ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ"); closeModal('saveModal'); document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = name);
        };
        window.loadPlansList = async () => {
            const listArea = document.getElementById('planList'); if(!listArea) return;
            listArea.innerHTML = 'èª­è¾¼ä¸­...';
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scenarios'));
            listArea.innerHTML = snap.empty ? 'ãƒ‡ãƒ¼ã‚¿ãªã—' : '';
            snap.forEach(d => {
                const p = d.data(); const item = document.createElement('div');
                item.className = "flex justify-between items-center p-4 border border-black rounded-xl hover:bg-blue-50 cursor-pointer mb-2";
                item.innerHTML = `<div class="flex-grow" onclick="window.fetchAndLoadPlan('${d.id}')"><b>${p.name}</b></div><button onclick="window.deletePlan('${d.id}')" class="text-rose-500 text-xs">å‰Šé™¤</button>`;
                listArea.appendChild(item);
            });
        };
        window.fetchAndLoadPlan = async (id) => {
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id));
            if (!snap.exists()) return;
            const p = snap.data(); Object.keys(p.config).forEach(k => { const el = document.getElementById(k); if(el) el.value = p.config[k]; });
            toggleChildInputs(); initTable();
            p.incomes.forEach(i => { const el = document.querySelector(`.income-input[data-cat="${i.cat}"][data-col="${i.col}"]`); if (el) el.value = i.val; });
            p.expenses.forEach(e => { const el = document.querySelector(`.expense-input[data-cat="${e.cat}"][data-col="${e.col}"]`); if (el) el.value = e.val; });
            document.querySelectorAll('.memo-input').forEach((el, idx) => { if (p.memos[idx]) el.value = p.memos[idx]; });
            document.querySelectorAll('.clientNameLabel').forEach(el => el.textContent = p.name);
            updateSimulation(); closeModal('loadModal'); window.showToast("ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        };
        window.deletePlan = async (id) => { if (confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scenarios', id)); window.loadPlansList(); } };
    </script>

    <script>
        let mainChart; let viewInterval = 1; let chartType = 'line';
        const expenseCats = [{id:'basicLiving', label:'åŸºæœ¬ç”Ÿæ´»è²»', def:240}, {id:'housing', label:'ä½å±…é–¢é€£è²»', def:120}, {id:'vehicle', label:'è»Šä¸¡è²»', def:30}, {id:'education', label:'æ•™è‚²è²»', def:30}, {id:'insurance', label:'ä¿é™ºæ–™', def:20}, {id:'other', label:'ãã®ä»–ã®æ”¯å‡º', def:10}];

        function initDate() { const d = new Date(); document.querySelectorAll('.todayDateLabel').forEach(el => el.textContent = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`); }
        function calculatePMT(principal, yearlyRate, years) { if (principal <= 0 || years <= 0) return 0; const r = yearlyRate / 100 / 12; const n = years * 12; if (r === 0) return (principal / years); const pmt = (principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1); return (pmt * 12); }
        function safeSetText(id, text) { const el = document.getElementById(id); if(el) el.textContent = text; }
        function toggleChildInputs() { const count = parseInt(document.getElementById('childCount').value); document.getElementById('c1_wrap').style.display = count >= 1 ? 'block' : 'none'; document.getElementById('c2_wrap').style.display = count >= 2 ? 'block' : 'none'; document.getElementById('c3_wrap').style.display = count >= 3 ? 'block' : 'none'; }
        function syncTableFromModal(tableId, val) { const el = document.getElementById(tableId); if(el) el.value = val; }
        function syncTableInputs() { const cVal = document.getElementById('currentCash').value; const ctVal = document.getElementById('currentCash_T'); if(ctVal) ctVal.value = cVal; const iVal = document.getElementById('currentInvest').value; const itVal = document.getElementById('currentInvest_T'); if(itVal) itVal.value = iVal; }

        function setChartType(type) { 
            chartType = type; document.getElementById('chartLine').classList.toggle('active', type === 'line'); document.getElementById('chartPie').classList.toggle('active', type === 'pie');
            const sw = document.getElementById('pieYearSelectorWrapper'); if(sw) sw.style.display = (type === 'pie') ? 'flex' : 'none';
            updateSimulation(); 
        }

        function initTable() {
            const duration = parseInt(document.getElementById('duration')?.value || 50);
            const columns = Array.from({length: duration + 1}, (_, i) => i);
            const yearSelector = document.getElementById('chartYearSelector');
            if(yearSelector) yearSelector.innerHTML = columns.map(c => `<option value="${c}">${c === 0 ? 'ç¾åœ¨' : c + 'å¹´å¾Œ'}</option>`).join('');
            
            const thead = document.getElementById('tableHeader');
            thead.innerHTML = `<tr class="bg-slate-800 text-white shadow-md"><th class="p-5 input-col text-slate-800">é …ç›®</th>${columns.map((c, i) => `<th class="p-5 text-center font-bold ${i===0?'bg-slate-700':''}">${c===0?'ç¾åœ¨':c+'å¹´å¾Œ'}</th>`).join('')}</tr>`;
            const tbody = document.getElementById('tableBody');
            
            let html = `<tr class="bg-amber-50/20"><td class="p-4 input-col font-bold border-b text-[11px]">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</td>${columns.map((_, i) => `<td class="p-2 border-b text-center"><textarea class="memo-input event-memo" data-col="${i}" oninput="updateSimulation()" placeholder="ãƒ¡ãƒ¢"></textarea></td>`).join('')}</tr>`;
            html += `<tr class="bg-slate-50"><td class="p-4 input-col font-bold border-b text-[11px]">æœ¬äººå¹´é½¢</td>${columns.map((_, i) => `<td class="p-3 border-b text-center font-bold text-slate-800" data-type="ageSelf" data-col="${i}">---</td>`).join('')}</tr>`;
            html += `<tr class="bg-slate-50/50"><td class="p-4 input-col font-bold border-b text-[11px]">é…å¶è€…å¹´é½¢</td>${columns.map((_, i) => `<td class="p-3 border-b text-center text-slate-500" data-type="ageSpouse" data-col="${i}">---</td>`).join('')}</tr>`;
            html += `<tr class="bg-slate-50/50 border-b-4"><td class="p-4 input-col font-bold text-[11px]">å®¶æ—ã®å¹´é½¢</td>${columns.map((_, i) => `<td class="p-3 border-b text-center text-[10px]" data-type="ageChildren" data-col="${i}">---</td>`).join('')}</tr>`;
            
            html += `<tr class="bg-blue-50 font-bold text-blue-700"><td class="p-4 input-col border-b">ã€åå…¥åˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalIncome" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr><td class="p-3 input-col pl-8 border-b text-xs">æœ¬äººåå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="self" data-col="${i}" value="500" oninput="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            html += `<tr><td class="p-3 input-col pl-8 border-b text-xs">é…å¶è€…åå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="spouse" data-col="${i}" value="150" oninput="handleIncomePropagate(this); updateSimulation();"></td>`).join('')}</tr>`;
            html += `<tr><td class="p-3 input-col pl-8 border-b font-bold text-blue-600 text-xs">ä½å®…ãƒ­ãƒ¼ãƒ³å€Ÿå…¥</td>${columns.map((_, i) => `<td class="p-2 border-b text-center text-blue-600 font-bold" data-type="loanIn" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr><td class="p-3 input-col pl-8 border-b text-xs">ä¸€æ™‚åå…¥/ä»–</td>${columns.map((_, i) => `<td class="p-2 border-b"><input type="number" class="table-input income-input" data-cat="tempInc" data-col="${i}" value="0" onchange="updateSimulation()"></td>`).join('')}</tr>`;
            
            html += `<tr class="bg-rose-50 font-bold text-rose-700"><td class="p-4 input-col border-b">ã€æ”¯å‡ºåˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalExpense" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr><td class="p-2 input-col pl-8 border-b font-bold text-rose-600 text-[10px]">åœŸåœ°å»ºç‰©(è‡ªå·±é‡‘)</td>${columns.map((_, i) => `<td class="p-1 border-b text-center font-bold text-rose-600" data-type="propertyOut" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr><td class="p-2 input-col pl-8 border-b font-bold text-rose-600 text-[10px]">ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ</td>${columns.map((_, i) => `<td class="p-1 border-b text-center" data-type="loanOut" data-col="${i}">0</td>`).join('')}</tr>`;
            expenseCats.forEach(cat => { html += `<tr><td class="p-2 input-col pl-8 border-b text-xs">${cat.label}</td>${columns.map((_, i) => `<td class="p-1 border-b"><input type="number" class="table-input expense-input" data-cat="${cat.id}" data-col="${i}" value="${cat.def}" onchange="updateSimulation()"></td>`).join('')}</tr>`; });
            
            html += `<tr class="asset-total-row font-bold text-white border-t-2"><td class="p-4 input-col bg-emerald-900 text-white border-b">ã€è³‡ç”£åˆè¨ˆã€‘</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="totalAssets" data-col="${i}">0</td>`).join('')}</tr>`;
            html += `<tr class="asset-sub-row text-xs"><td class="p-2 input-col pl-8 border-b">å†…ï¼šç¾é‡‘ãƒ»é è²¯é‡‘</td><td class="p-2 border-b text-center"><input type="number" id="currentCash_T" class="table-input" onchange="syncAndRefresh('currentCash', this.value)"></td>${columns.slice(1).map((_, i) => `<td class="p-2 border-b text-center" data-type="assetCash" data-col="${i+1}">0</td>`).join('')}</tr>`;
            html += `<tr class="asset-sub-row border-b-2 text-xs"><td class="p-2 input-col pl-8 border-b font-medium text-emerald-700">å†…ï¼šæŠ•è³‡è³‡ç”£</td><td class="p-2 border-b text-center"><input type="number" id="currentInvest_T" class="table-input" onchange="syncAndRefresh('currentInvest', this.value)"></td>${columns.slice(1).map((_, i) => `<td class="p-2 border-b text-center text-emerald-700" data-type="assetInvest" data-col="${i+1}">0</td>`).join('')}</tr>`;
            
            html += `<tr class="bg-slate-100 font-bold"><td class="p-4 input-col bg-slate-200 border-b text-[11px]">å¹´é–“åæ”¯</td>${columns.map((_, i) => `<td class="p-4 border-b text-center font-bold" data-type="balance" data-col="${i}">0</td>`).join('')}</tr>`;
            tbody.innerHTML = html; syncTableInputs();
        }

        function handleIncomePropagate(el) {
            const cat = el.dataset.cat; const val = el.value; const changedCol = parseInt(el.dataset.col);
            document.querySelectorAll(`.income-input[data-cat="${cat}"]`).forEach(input => { if (parseInt(input.dataset.col) > changedCol) input.value = val; });
        }

        window.updateSimulation = () => {
            const baseAge = parseInt(document.getElementById('baseAge')?.value || 35);
            const spouseAge = parseInt(document.getElementById('spouseAge')?.value || 32);
            const duration = parseInt(document.getElementById('duration')?.value || 50);
            const childCount = parseInt(document.getElementById('childCount').value);
            const c1 = parseInt(document.getElementById('child1Age')?.value || 0);
            const c2 = parseInt(document.getElementById('child2Age')?.value || 0);
            const c3 = parseInt(document.getElementById('child3Age')?.value || 0);
            const propTotal = parseFloat(document.getElementById('propertyTotal')?.value || 0);
            const initCash = parseFloat(document.getElementById('currentCash')?.value || 0);
            const initInvest = parseFloat(document.getElementById('currentInvest')?.value || 0);
            const loanAmt = parseFloat(document.getElementById('loanAmount')?.value || 0);
            const loanRate = parseFloat(document.getElementById('loanRate')?.value || 1.0);
            const loanYears = 35; 
            const invRate = parseFloat(document.getElementById('investRate')?.value || 3.0) / 100;
            const parentSupport = parseFloat(document.getElementById('parentSupport')?.value || 0);

            const loanRepaymentYear = calculatePMT(loanAmt, loanRate, loanYears);
            safeSetText('calcLoanRepay', Math.floor(loanRepaymentYear).toLocaleString());
            safeSetText('summaryDuration', `${baseAge+duration}æ­³ã¾ã§ (${duration}å¹´)`);
            safeSetText('summaryLoan', `Â¥${loanAmt.toLocaleString()}ä¸‡`);
            safeSetText('summaryYield', `${(invRate*100).toFixed(1)}%`);
            safeSetText('summaryProperty', `Â¥${propTotal.toLocaleString()}ä¸‡`);

            let runningCash = initCash + parentSupport; let runningInvest = initInvest; let loanBalance = loanAmt;
            const yearlyData = [];

            for (let year = 0; year <= duration; year++) {
                let tInc = 0; document.querySelectorAll(`.income-input[data-col="${year}"]`).forEach(el => tInc += parseFloat(el.value || 0));
                const loanIn = (year === 0) ? loanAmt : 0; tInc += loanIn;
                const propertyOut = (year === 0) ? propTotal : 0;
                let tExp = 0; document.querySelectorAll(`.expense-input[data-col="${year}"]`).forEach(el => tExp += parseFloat(el.value || 0));
                tExp += propertyOut;
                let curLoanOut = 0; if (year > 0 && year <= loanYears && loanBalance > 0) { const iY = loanBalance * (loanRate / 100); curLoanOut = Math.min(loanRepaymentYear, loanBalance + iY); loanBalance = Math.max(0, loanBalance + iY - curLoanOut); }
                tExp += curLoanOut;
                if (year > 0) runningInvest *= (1 + invRate);
                const bal = tInc - tExp; runningCash += bal;

                const sel = (type) => document.querySelector(`[data-type="${type}"][data-col="${year}"]`);
                if(sel('ageSelf')) sel('ageSelf').textContent = `${baseAge+year}æ­³`;
                if(sel('ageSpouse')) sel('ageSpouse').textContent = `${spouseAge+year}æ­³`;
                const childInfo = []; if(childCount>=1) childInfo.push(c1+year); if(childCount>=2) childInfo.push(c2+year); if(childCount>=3) childInfo.push(c3+year);
                if(sel('ageChildren')) sel('ageChildren').textContent = childInfo.length > 0 ? childInfo.join(', ') : '---';
                if(sel('totalIncome')) sel('totalIncome').textContent = Math.floor(tInc).toLocaleString();
                if(sel('loanIn')) sel('loanIn').textContent = loanIn.toLocaleString(); 
                if(sel('totalExpense')) sel('totalExpense').textContent = Math.floor(tExp).toLocaleString();
                if(sel('propertyOut')) sel('propertyOut').textContent = (year===0 ? Math.max(0, propTotal - loanAmt) : 0).toLocaleString();
                if(sel('loanOut')) sel('loanOut').textContent = Math.floor(curLoanOut).toLocaleString();
                if (year > 0) { if(sel('assetCash')) sel('assetCash').textContent = Math.floor(runningCash).toLocaleString(); if(sel('assetInvest')) sel('assetInvest').textContent = Math.floor(runningInvest).toLocaleString(); }
                const totalAsset = runningCash + runningInvest;
                const aEl = sel('totalAssets'); if(aEl) { aEl.textContent = Math.floor(totalAsset).toLocaleString(); aEl.className = `p-4 border-b text-center font-bold ${totalAsset>=0?'text-emerald-700':'text-rose-700'}`; }
                const bEl = sel('balance'); if(bEl) { bEl.textContent = (bal>=0?'+':'') + Math.floor(bal).toLocaleString(); bEl.className = `p-4 border-b text-center font-bold ${bal>=0?'text-emerald-600':'text-rose-600'}`; }

                yearlyData.push({ 
                    year, ageSelf: baseAge+year, ageSpouse: spouseAge+year, childAges: childInfo.join(', '), memo: document.querySelector(`.event-memo[data-col="${year}"]`)?.value || "",
                    income: tInc, expense: tExp, cash: runningCash, invest: runningInvest, assets: runningCash + runningInvest,
                    selfInc: parseFloat(document.querySelector(`.income-input[data-cat="self"][data-col="${year}"]`)?.value || 0),
                    spouseInc: parseFloat(document.querySelector(`.income-input[data-cat="spouse"][data-col="${year}"]`)?.value || 0),
                    loanIn, tempInc: parseFloat(document.querySelector(`.income-input[data-cat="tempInc"][data-col="${year}"]`)?.value || 0),
                    propertyOut: (year===0 ? Math.max(0, propTotal - loanAmt) : 0), loanOut: curLoanOut,
                    exps: expenseCats.map(c => ({ label: c.label, val: parseFloat(document.querySelector(`.expense-input[data-cat="${c.id}"][data-col="${year}"]`)?.value || 0) }))
                });
            }
            window.lastData = yearlyData; renderCharts(yearlyData);
        };

        function renderCharts(data) {
            const ctxEl = document.getElementById('mainChart'); if(!ctxEl) return;
            const ctx = ctxEl.getContext('2d'); if (mainChart) mainChart.destroy();
            const yrSelector = parseInt(document.getElementById('chartYearSelector')?.value || 0);
            const dSelected = data.find(i => i.year === yrSelector) || data[0];

            if (chartType === 'line') {
                const labels = data.filter((d,i) => i % 2 === 0).map(d => `${d.ageSelf}æ­³`);
                const assets = data.filter((d,i) => i % 2 === 0).map(d => d.assets);
                mainChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'ç·è³‡ç”£é¡', data: assets, borderColor: '#002D5B', backgroundColor: 'rgba(0,45,91,0.05)', fill: true, tension: 0.3 }] }, options: { maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } } } });
            } else {
                const ins = [{ label: 'æœ¬äºº', val: dSelected.selfInc }, { label: 'é…å¶è€…', val: dSelected.spouseInc }, { label: 'å€Ÿå…¥', val: dSelected.loanIn }, { label: 'ä»–', val: dSelected.tempInc }].filter(i => i.val > 0);
                const exs = [{ label: 'ç‰©ä»¶é‡‘', val: dSelected.propertyOut }, { label: 'ãƒ­ãƒ¼ãƒ³', val: dSelected.loanOut }, ...dSelected.exps].filter(i => i.val > 0);
                const inPal = ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd']; const exPal = ['#991b1b', '#dc2626', '#ef4444', '#f87171', '#fca5a5', '#fecaca'];
                mainChart = new Chart(ctx, { type: 'doughnut', data: { labels: [...ins, ...exs].map(i => i.label), datasets: [{ data: [...ins, ...exs].map(i => i.val), backgroundColor: [...ins.map((_,i)=>inPal[i%inPal.length]), ...exs.map((_,i)=>exPal[i%exPal.length])], borderWidth: 1 }] }, options: { maintainAspectRatio: false, animation: false, plugins: { legend: { position: 'right' } } } });
            }
        }

        // --- è³‡ç”£æ¨ç§»PDFå‡ºåŠ›ï¼ˆå…¨é …ç›®ãƒ»å…¨ã‚°ãƒ©ãƒ•ï¼‰ ---
        function prepareAndPrintAssets() {
            const data = window.lastData; if(!data) return;
            const printArea = document.getElementById('printOnlyArea'); printArea.innerHTML = '';
            
            // è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’ç”»åƒåŒ–ï¼ˆç¢ºå®Ÿã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ä¸€æ™‚çš„ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§æç”»ï¼‰
            const lineImg = mainChart.toBase64Image();
            
            let html = `
                <div class="print-cover">
                    <h1>ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ»åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å ±å‘Šæ›¸</h1>
                    <p>é¡§å®¢åï¼š${document.querySelector('.clientNameLabel').innerText} æ§˜</p>
                    <p>ä½œæˆæ—¥ï¼š${new Date().toLocaleDateString('ja-JP')}</p>
                </div>
                <div class="page-break">
                    <h2>1. æ¦‚è¦ã‚µãƒãƒªãƒ¼ã¨è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                    <div class="print-summary-grid">
                        <div class="print-summary-item"><label>æœŸé–“</label><span>${document.getElementById('summaryDuration').innerText}</span></div>
                        <div class="print-summary-item"><label>åœŸåœ°å»ºç‰©ç·é¡</label><span>${document.getElementById('summaryProperty').innerText}</span></div>
                        <div class="print-summary-item"><label>ãƒ­ãƒ¼ãƒ³å€Ÿå…¥é¡</label><span>${document.getElementById('summaryLoan').innerText}</span></div>
                        <div class="print-summary-item"><label>é‹ç”¨åˆ©å›ã‚Š</label><span>${document.getElementById('summaryYield').innerText}</span></div>
                    </div>
                    <div style="text-align:center;"><img src="${lineImg}" class="print-chart-img"></div>
                </div>
            `;
            printArea.innerHTML = html;

            const chunkSize = 15;
            for(let p = 0; p < Math.ceil(data.length / chunkSize); p++) {
                const chunk = data.slice(p * chunkSize, (p + 1) * chunkSize);
                const table = document.createElement('table'); 
                if (p < Math.ceil(data.length / chunkSize) - 1) table.className = "page-break";
                
                let tHtml = `<tr class="bg-slate-800 text-white"><th class="print-label-col">é …ç›® / çµŒéå¹´</th>${chunk.map(d => `<th>${d.year===0?'ç¾åœ¨':d.year+'å¹´å¾Œ'}</th>`).join('')}</tr>`;
                tHtml += `<tr><td class="print-label-col">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</td>${chunk.map(d => `<td>${d.memo}</td>`).join('')}</tr>`;
                tHtml += `<tr><td class="print-label-col">å¹´é½¢(æœ¬äººãƒ»é…)</td>${chunk.map(d => `<td>${d.ageSelf}/${d.ageSpouse}æ­³</td>`).join('')}</tr>`;
                tHtml += `<tr><td class="print-label-col">å­ä¾›ã®å¹´é½¢</td>${chunk.map(d => `<td>${d.childAges}</td>`).join('')}</tr>`;
                
                tHtml += `<tr class="print-income-header"><td>ã€åå…¥åˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.income).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-row"><td class="print-sub-label">æœ¬äººåå…¥</td>${chunk.map(d => `<td>${Math.floor(d.selfInc).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-row"><td class="print-sub-label">é…å¶è€…åå…¥</td>${chunk.map(d => `<td>${Math.floor(d.spouseInc).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-income-row"><td class="print-sub-label">å€Ÿå…¥ãƒ»ä¸€æ™‚é‡‘</td>${chunk.map(d => `<td>${Math.floor(d.loanIn + d.tempInc).toLocaleString()}</td>`).join('')}</tr>`;

                tHtml += `<tr class="print-expense-header"><td>ã€æ”¯å‡ºåˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.expense).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-expense-row"><td class="print-sub-label">ä½å®…ãƒ»ãƒ­ãƒ¼ãƒ³æ”¯æ‰•</td>${chunk.map(d => `<td>${Math.floor(d.loanOut + d.propertyOut).toLocaleString()}</td>`).join('')}</tr>`;
                expenseCats.forEach((cat, idx) => {
                    tHtml += `<tr class="print-expense-row"><td class="print-sub-label">${cat.label}</td>${chunk.map(d => `<td>${Math.floor(d.exps[idx].val).toLocaleString()}</td>`).join('')}</tr>`;
                });

                tHtml += `<tr class="print-asset-header"><td>ã€è³‡ç”£åˆè¨ˆã€‘</td>${chunk.map(d => `<td>${Math.floor(d.assets).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-asset-row"><td class="print-sub-label">å†…ï¼šç¾é‡‘ãƒ»é é‡‘</td>${chunk.map(d => `<td>${Math.floor(d.cash).toLocaleString()}</td>`).join('')}</tr>`;
                tHtml += `<tr class="print-asset-row"><td class="print-sub-label">å†…ï¼šæŠ•è³‡è³‡ç”£</td>${chunk.map(d => `<td>${Math.floor(d.invest).toLocaleString()}</td>`).join('')}</tr>`;
                
                table.innerHTML = tHtml; printArea.appendChild(table);
            }
            window.print();
        }

        // --- å…¨åæ”¯æ§‹æˆPDFå‡ºåŠ›ï¼ˆå…¨å¹´åº¦å††ã‚°ãƒ©ãƒ•ä¸€è¦§ï¼‰ ---
        async function prepareAndPrintBreakdown() {
            const data = window.lastData; if(!data) return;
            const printArea = document.getElementById('printOnlyArea'); printArea.innerHTML = '';
            
            let html = `
                <div class="print-cover">
                    <h1>å¹´åº¦åˆ¥ãƒ»åæ”¯æ§‹æˆåˆ†æä¸€è¦§</h1>
                    <p>é¡§å®¢åï¼š${document.querySelector('.clientNameLabel').innerText} æ§˜</p>
                </div>
                <div class="page-break">
                    <h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨æœŸé–“ã®åæ”¯å†…è¨³å††ã‚°ãƒ©ãƒ•</h2>
                    <div class="pie-grid" id="piePrintGrid"></div>
                </div>
            `;
            printArea.innerHTML = html;
            const grid = document.getElementById('piePrintGrid');

            // éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ•ã«ã—ã¦ç¢ºå®Ÿã«ç”»åƒåŒ–ï¼‰
            const hCanvas = document.getElementById('hiddenPieCanvas');
            const hCtx = hCanvas.getContext('2d');
            const inPal = ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd']; const exPal = ['#991b1b', '#dc2626', '#ef4444', '#f87171', '#fca5a5', '#fecaca'];

            const tempPie = new Chart(hCtx, {
                type: 'doughnut',
                options: { animation: false, responsive: false, plugins: { legend: { display: false } } }
            });

            for (const d of data) {
                const ins = [{ label: 'æœ¬äºº', val: d.selfInc }, { label: 'é…å¶è€…', val: d.spouseInc }, { label: 'å€Ÿå…¥', val: d.loanIn }, { label: 'ä»–', val: d.tempInc }].filter(i => i.val > 0);
                const exs = [{ label: 'ç‰©ä»¶é‡‘', val: d.propertyOut }, { label: 'ãƒ­ãƒ¼ãƒ³', val: d.loanOut }, ...d.exps].filter(i => i.val > 0);
                const all = [...ins, ...exs];
                
                tempPie.data = {
                    labels: all.map(i => i.label),
                    datasets: [{
                        data: all.map(i => i.val),
                        backgroundColor: [...ins.map((_,i)=>inPal[i%inPal.length]), ...exs.map((_,i)=>exPal[i%exPal.length])],
                        borderWidth: 1
                    }]
                };
                tempPie.update();
                const img = tempPie.toBase64Image();
                
                const item = document.createElement('div');
                item.className = "pie-item";
                item.innerHTML = `<p>${d.year === 0 ? 'ç¾åœ¨' : d.year + 'å¹´å¾Œ'} (${d.ageSelf}æ­³)</p><img src="${img}">`;
                grid.appendChild(item);
            }
            window.print();
        }

        window.openModal = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'flex'; if(id==='loadModal') window.loadPlansList(); };
        window.closeModal = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'none'; };
        window.showToast = (msg) => { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); };
        
        document.addEventListener('DOMContentLoaded', () => { 
            initDate(); 
            toggleChildInputs(); 
            initTable(); 
            updateSimulation(); 
        });
    </script>
</body>
</html>